<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Proyectos v11.0 - Firebase</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase v9 - Modular SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, setDoc, doc, onSnapshot, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyASZYa_ByZkFUn1VPGORx45D84_vKg9MQw",
            authDomain: "gestion-proyectos-609cd.firebaseapp.com",
            projectId: "gestion-proyectos-609cd",
            storageBucket: "gestion-proyectos-609cd.firebasestorage.app",
            messagingSenderId: "794788748744",
            appId: "1:794788748744:web:f62696b7c8f9cbf4eb34fd"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Exponer funciones globalmente para que React pueda usarlas
        window.firebaseDB = db;
        window.firebaseCollection = collection;
        window.firebaseGetDocs = getDocs;
        window.firebaseSetDoc = setDoc;
        window.firebaseDoc = doc;
        window.firebaseOnSnapshot = onSnapshot;
        window.firebaseDeleteDoc = deleteDoc;
        window.firebaseInitialized = true;
    </script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const DATA_VERSION = "11.5 - Firebase ID Fix"; // Cambiar esta versi√≥n fuerza recarga de datos
        const INITIAL_DATA = {
            miembros: [
                { id: 2, nombre: "Alonso Zapata", roles: ["Programadores", "Guardi√°n de Calidad", "Responsable de Datos y Aprendizaje Estrat√©gico", "Innovaci√≥n Tec", "Strategic Challenger"] },
                { id: 3, nombre: "Andrea Chac√≥n", roles: ["Navegante de Ruta", "Modelador de Comportamiento", "Responsable de Datos y Aprendizaje Estrat√©gico", "Consultores/facilitadores", "Lider de especialidad", "Donantes", "Strategic Challenger"] },
                { id: 4, nombre: "Andrea Duran", roles: ["Catalizador de Ecosistema", "Especialista en Vinculaci√≥n", "Estratega de Tracci√≥n Multicanal", "Posicionamiento"] },
                { id: 5, nombre: "Arlene Guerrero", roles: ["Navegante de Ruta", "Modelador de Comportamiento", "Catalizador de Ecosistema", "Finanzas y Compliance"] },
                { id: 6, nombre: "Benjamin Tapia", roles: ["Arquitecto de Valor", "Modelador de Comportamiento", "Catalizador de Ecosistema", "Consultores/facilitadores", "Lider de especialidad", "Monetizaci√≥n", "Comercializador Empresa B"] },
                { id: 7, nombre: "Betsaida Olivares", roles: ["Navegante de Ruta", "Programadores", "Guardi√°n de Calidad", "Modelador de Comportamiento", "Consultores/facilitadores", "Lider de especialidad", "Gobernanza + Estrategia (Futuro)", "Innovaci√≥n Tec", "Strategic Challenger"] },
                { id: 8, nombre: "Blanca Godoy", roles: ["Navegante de Ruta", "Finanzas y Compliance"] },
                { id: 9, nombre: "Cecilia Foxworthy", roles: ["Catalizador de Ecosistema", "Especialista Conector Estrat√©gico", "Gobernanza + Estrategia (Futuro)", "Donantes"] },
                { id: 10, nombre: "Christian Holnes", roles: ["Responsable de Datos y Aprendizaje Estrat√©gico"] },
                { id: 11, nombre: "Claudia Garc√≠a", roles: ["Especialista en Vinculaci√≥n", "Estratega de Tracci√≥n Multicanal", "Posicionamiento"] },
                { id: 12, nombre: "Cristhella Santizo", roles: ["Modelador de Comportamiento", "Catalizador de Ecosistema", "Responsable de Datos y Aprendizaje Estrat√©gico", "Consultores/facilitadores", "Estratega de Tracci√≥n Multicanal", "Comercializador Empresa B"] },
                { id: 13, nombre: "Daniela Guzman", roles: ["Navegante de Ruta", "Gobernanza + Estrategia (Futuro)", "Personas y Cultura", "Strategic Challenger"] },
                { id: 14, nombre: "Delfina Maquieira", roles: ["Personas y Cultura"] },
                { id: 15, nombre: "Fabian Medina", roles: ["Arquitecto de Valor", "Programadores", "Guardi√°n de Calidad", "Dise√±ador UX/UI", "Innovaci√≥n Tec"] },
                { id: 16, nombre: "Florencia Jeifetz", roles: ["Navegante de Ruta", "Arquitecto de Valor", "Dise√±ador UX/UI", "Especialista Conector Estrat√©gico", "Lider de especialidad", "Gobernanza + Estrategia (Futuro)", "Monetizaci√≥n", "Donantes", "Strategic Challenger"] },
                { id: 17, nombre: "Jessica Lemus", roles: ["Modelador de Comportamiento", "Catalizador de Ecosistema", "Especialista Conector Estrat√©gico", "Consultores/facilitadores", "Lider de especialidad"] },
                { id: 18, nombre: "Jorge Donado", roles: ["Consultores/facilitadores", "Personas y Cultura"] },
                { id: 19, nombre: "Juan Esteban garc√≠a vinasco", roles: ["Consultores/facilitadores"] },
                { id: 20, nombre: "Kirely Macedo", roles: ["Modelador de Comportamiento", "Catalizador de Ecosistema", "Especialista Conector Estrat√©gico", "Consultores/facilitadores", "Especialista en Vinculaci√≥n", "Estratega de Tracci√≥n Multicanal", "Posicionamiento"] },
                { id: 21, nombre: "Lenin Flores", roles: ["Navegante de Ruta", "Programadores", "Guardi√°n de Calidad", "Lider de especialidad", "Gobernanza + Estrategia (Futuro)", "Innovaci√≥n Tec"] },
                { id: 22, nombre: "Liesl Hros", roles: ["Navegante de Ruta", "Arquitecto de Valor", "Dise√±ador UX/UI", "Catalizador de Ecosistema", "Especialista Conector Estrat√©gico", "Gobernanza + Estrategia (Futuro)", "Posicionamiento", "Monetizaci√≥n"] },
                { id: 23, nombre: "Lilian Duarte", roles: ["Arquitecto de Valor", "Guardi√°n de Calidad", "Dise√±ador UX/UI", "Modelador de Comportamiento", "Lider de especialidad"] },
                { id: 24, nombre: "Lizett Hern√°ndez", roles: ["Finanzas y Compliance"] },
                { id: 25, nombre: "Lucas Puente", roles: ["Navegante de Ruta", "Especialista Conector Estrat√©gico", "Consultores/facilitadores", "Gobernanza + Estrategia (Futuro)", "Monetizaci√≥n", "Donantes", "Comercializador Empresa B", "Strategic Challenger"] },
                { id: 26, nombre: "Madelyn Gutierrez", roles: ["Arquitecto de Valor", "Dise√±ador UX/UI", "Modelador de Comportamiento", "Consultores/facilitadores", "Lider de especialidad", "Especialista en Vinculaci√≥n", "Estratega de Tracci√≥n Multicanal", "Personas y Cultura", "Innovaci√≥n Tec"] },
                { id: 27, nombre: "Maria Andrea Diaz", roles: ["Catalizador de Ecosistema", "Especialista en Vinculaci√≥n", "Estratega de Tracci√≥n Multicanal"] },
                { id: 28, nombre: "Maria Denise Duarte", roles: ["Especialista Conector Estrat√©gico", "Gobernanza + Estrategia (Futuro)", "Finanzas y Compliance", "Donantes"] },
                { id: 29, nombre: "Maria Fernanda Hern√°ndez", roles: ["Catalizador de Ecosistema", "Especialista Conector Estrat√©gico"] },
                { id: 30, nombre: "Mariana Alcal√° Lopez", roles: ["Consultores/facilitadores", "Especialista en Vinculaci√≥n"] },
                { id: 31, nombre: "Mariana Flores", roles: ["Modelador de Comportamiento", "Catalizador de Ecosistema", "Consultores/facilitadores", "Especialista en Vinculaci√≥n", "Estratega de Tracci√≥n Multicanal"] },
                { id: 32, nombre: "Milena Gait√°n", roles: ["Monetizaci√≥n", "Donantes", "Comercializador Empresa B"] },
                { id: 33, nombre: "Miurel Medrano", roles: ["Responsable de Datos y Aprendizaje Estrat√©gico"] },
                { id: 34, nombre: "Paola Orellana", roles: ["Catalizador de Ecosistema", "Consultores/facilitadores", "Especialista en Vinculaci√≥n"] },
                { id: 35, nombre: "Roberto Rodr√≠guez", roles: ["Arquitecto de Valor", "Guardi√°n de Calidad", "Dise√±ador UX/UI", "Responsable de Datos y Aprendizaje Estrat√©gico"] },
                { id: 36, nombre: "Roger Palma", roles: ["Consultores/facilitadores", "Finanzas y Compliance", "Personas y Cultura"] },
                { id: 38, nombre: "Sebastian Guirao", roles: ["Navegante de Ruta", "Arquitecto de Valor", "Dise√±ador UX/UI", "Lider de especialidad", "Especialista en Vinculaci√≥n", "Monetizaci√≥n"] },
                { id: 39, nombre: "Svetlana Urbina", roles: ["Catalizador de Ecosistema", "Especialista Conector Estrat√©gico", "Especialista en Vinculaci√≥n", "Estratega de Tracci√≥n Multicanal", "Posicionamiento", "Comercializador Empresa B"] },
                { id: 40, nombre: "Tania Guti√©rrez", roles: ["Personas y Cultura"] },
                { id: 41, nombre: "Valeria Sequeira", roles: ["Catalizador de Ecosistema", "Consultores/facilitadores", "Finanzas y Compliance", "Monetizaci√≥n", "Comercializador Empresa B", "Strategic Challenger"] }
            ],
            entidades: [
                {
                    id: 'capa-central',
                    nombre: "Capa Central",
                    tipo: "Entidad",
                    roles: [],
                    fechaInicio: null,
                    fechaFin: null,
                    asignaciones: []
                },
                {
                    id: 'hub-crecimiento',
                    nombre: "Hub Crecimiento",
                    tipo: "Entidad",
                    roles: [],
                    fechaInicio: null,
                    fechaFin: null,
                    asignaciones: []
                },
                {
                    id: 'nucleo-infraestructura',
                    nombre: "N√∫cleo de infraestructura",
                    tipo: "Entidad",
                    roles: [],
                    fechaInicio: null,
                    fechaFin: null,
                    asignaciones: []
                }
            ],
            proyectos: [
                {
                    id: 1, nombre: "Juntas Contamos", categoria: "Semipermanente",
                    roles: [],
                    fechaInicio: null, fechaFin: null, asignaciones: []
                },
                {
                    id: 2, nombre: "Formando Catalizadores", categoria: "Semipermanente",
                    roles: [],
                    fechaInicio: null, fechaFin: null, asignaciones: []
                },
                {
                    id: 3, nombre: "Colmena", categoria: "Semipermanente",
                    roles: [],
                    fechaInicio: null, fechaFin: null, asignaciones: []
                },
                {
                    id: 4, nombre: "Sustentia", categoria: "Semipermanente",
                    roles: [],
                    fechaInicio: null, fechaFin: null, asignaciones: []
                },
                {
                    id: 5, nombre: "WeCode", categoria: "Semipermanente",
                    roles: [],
                    fechaInicio: null, fechaFin: null, asignaciones: []
                }
            ],
            tiposIntervencion: { "Obligatorio": 50, "Esencial": 40, "Polinizador": 20, "Capa Central": 30, "Hub de crecimiento": 30, "Complementario": 30, "Contribuyente Clave": 40, "Especialista Activable": 30 }
        };

        function App() {
            const [miembros, setMiembros] = useState([]);
            const [entidades, setEntidades] = useState([]);
            const [proyectos, setProyectos] = useState([]);
            const [tiposIntervencion] = useState(INITIAL_DATA.tiposIntervencion);
            const [vistaActual, setVistaActual] = useState('dashboard');
            const [showModalMiembro, setShowModalMiembro] = useState(false);
            const [showModalProyecto, setShowModalProyecto] = useState(false);
            const [showModalEntidad, setShowModalEntidad] = useState(false);
            const [showModalRol, setShowModalRol] = useState(false);
            const [miembroEdit, setMiembroEdit] = useState(null);
            const [proyectoEdit, setProyectoEdit] = useState(null);
            const [entidadEdit, setEntidadEdit] = useState(null);
            const [rolEdit, setRolEdit] = useState(null);

            // Cargar datos desde Firebase al iniciar
            useEffect(() => {
                const loadFromFirebase = async () => {
                    // Esperar a que Firebase est√© inicializado
                    if (!window.firebaseInitialized) {
                        setTimeout(loadFromFirebase, 100);
                        return;
                    }

                    try {
                        const db = window.firebaseDB;
                        
                        // Cargar miembros
                        const miembrosSnap = await window.firebaseGetDocs(window.firebaseCollection(db, 'miembros'));
                        if (!miembrosSnap.empty) {
                            const miembrosData = miembrosSnap.docs.map(doc => doc.data());
                            setMiembros(miembrosData);
                        } else {
                            // Si no hay datos, usar INITIAL_DATA y guardar
                            setMiembros(INITIAL_DATA.miembros);
                            INITIAL_DATA.miembros.forEach(async (miembro) => {
                                await window.firebaseSetDoc(window.firebaseDoc(db, 'miembros', String(miembro.id)), miembro);
                            });
                        }

                        // Cargar entidades
                        const entidadesSnap = await window.firebaseGetDocs(window.firebaseCollection(db, 'entidades'));
                        const entidadesBase = INITIAL_DATA.entidades; // Siempre incluir las 3 bases
                        
                        if (!entidadesSnap.empty) {
                            const entidadesData = entidadesSnap.docs.map(doc => doc.data());
                            // Combinar entidades base con las creadas por usuario
                            const entidadesIds = new Set(entidadesData.map(e => e.id));
                            const entidadesBaseNoRepetidas = entidadesBase.filter(e => !entidadesIds.has(e.id));
                            setEntidades([...entidadesBaseNoRepetidas, ...entidadesData]);
                        } else {
                            setEntidades(entidadesBase);
                            entidadesBase.forEach(async (entidad) => {
                                await window.firebaseSetDoc(window.firebaseDoc(db, 'entidades', entidad.id), entidad);
                            });
                        }

                        // Cargar proyectos
                        const proyectosSnap = await window.firebaseGetDocs(window.firebaseCollection(db, 'proyectos'));
                        const proyectosSemipermanentes = INITIAL_DATA.proyectos.filter(p => p.categoria === 'Semipermanente');
                        
                        if (!proyectosSnap.empty) {
                            const proyectosData = proyectosSnap.docs.map(doc => doc.data());
                            const proyectosNoSemipermanentes = proyectosData.filter(p => p.categoria !== 'Semipermanente');
                            setProyectos([...proyectosSemipermanentes, ...proyectosNoSemipermanentes]);
                        } else {
                            setProyectos(INITIAL_DATA.proyectos);
                            INITIAL_DATA.proyectos.filter(p => p.categoria !== 'Semipermanente').forEach(async (proyecto) => {
                                await window.firebaseSetDoc(window.firebaseDoc(db, 'proyectos', proyecto.id), proyecto);
                            });
                        }
                        
                    } catch (error) {
                        console.error('Error cargando desde Firebase:', error);
                        // Si falla Firebase, usar localStorage como fallback
                        const savedData = localStorage.getItem('gestionProyectosData');
                        if (savedData) {
                            const data = JSON.parse(savedData);
                            setMiembros(data.miembros || INITIAL_DATA.miembros);
                            setEntidades(data.entidades || INITIAL_DATA.entidades);
                            setProyectos(data.proyectos || INITIAL_DATA.proyectos);
                        } else {
                            setMiembros(INITIAL_DATA.miembros);
                            setEntidades(INITIAL_DATA.entidades);
                            setProyectos(INITIAL_DATA.proyectos);
                        }
                    }
                };

                loadFromFirebase();
            }, []);

            // Guardar en Firebase cuando cambien los datos
            useEffect(() => {
                const saveToFirebase = async () => {
                    if (!window.firebaseInitialized || miembros.length === 0) return;

                    try {
                        const db = window.firebaseDB;
                        
                        console.log('üíæ Iniciando guardado en Firebase...', { 
                            miembrosCount: miembros.length, 
                            entidadesCount: entidades.length, 
                            proyectosCount: proyectos.length 
                        });
                        
                        // Guardar miembros - ESPERAR a que terminen todos
                        await Promise.all(
                            miembros.map(miembro => 
                                window.firebaseSetDoc(window.firebaseDoc(db, 'miembros', String(miembro.id)), miembro)
                            )
                        );

                        // Guardar entidades - ESPERAR a que terminen todas
                        await Promise.all(
                            entidades.map(entidad => {
                                console.log('üíæ Guardando entidad en Firebase:', { id: entidad.id, nombre: entidad.nombre });
                                return window.firebaseSetDoc(window.firebaseDoc(db, 'entidades', String(entidad.id)), entidad);
                            })
                        );
                        console.log('‚úÖ Entidades guardadas:', entidades.map(e => e.nombre).join(', '));

                        // Guardar proyectos (excepto semipermanentes) - ESPERAR a que terminen todos
                        const proyectosAGuardar = proyectos.filter(p => p.categoria !== 'Semipermanente');
                        await Promise.all(
                            proyectosAGuardar.map(proyecto => {
                                console.log('üíæ Guardando proyecto en Firebase:', { id: proyecto.id, nombre: proyecto.nombre });
                                return window.firebaseSetDoc(window.firebaseDoc(db, 'proyectos', String(proyecto.id)), proyecto);
                            })
                        );
                        
                        console.log('‚úÖ TODO GUARDADO EN FIREBASE EXITOSAMENTE');
                        
                        // Tambi√©n guardar en localStorage como backup
                        localStorage.setItem('gestionProyectosData', JSON.stringify({ 
                            miembros, 
                            entidades, 
                            proyectos: proyectosAGuardar 
                        }));
                    } catch (error) {
                        console.error('‚ùå Error guardando en Firebase:', error);
                        // Si falla Firebase, al menos guardar en localStorage
                        const proyectosAGuardar = proyectos.filter(p => p.categoria !== 'Semipermanente');
                        localStorage.setItem('gestionProyectosData', JSON.stringify({ 
                            miembros, 
                            entidades, 
                            proyectos: proyectosAGuardar 
                        }));
                    }
                };

                saveToFirebase();
            }, [miembros, entidades, proyectos]);

            const calcularDisponibilidad = (miembroId) => {
                let cargaTotal = 0;
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                
                [...proyectos, ...entidades].forEach(item => {
                    item.asignaciones?.forEach(asig => {
                        if (asig.miembroId === miembroId) {
                            // Si es asignaci√≥n directa, usar el porcentaje guardado
                            if (asig.rol === 'Asignaci√≥n Directa') {
                                cargaTotal += asig.porcentaje || 0;
                            } else {
                                // Si es rol normal, usar el porcentaje individual de la asignaci√≥n
                                // Si no tiene porcentaje individual, buscar en el rol, luego en tipo
                                let cargaRol = asig.porcentaje;
                                
                                if (!cargaRol) {
                                    const rol = item.roles.find(r => r.nombre === asig.rol);
                                    if (rol) {
                                        cargaRol = rol.porcentaje || tiposIntervencion[rol.tipo] || 0;
                                    }
                                }
                                
                                // REGLA ESPECIAL: Navegante de Ruta = 70% en los primeros 3 meses
                                if (asig.rol === 'Navegante de Ruta' && item.fechaInicio && !asig.porcentaje) {
                                    const fechaInicio = new Date(item.fechaInicio);
                                    fechaInicio.setHours(0, 0, 0, 0);
                                    const fechaLimite = new Date(fechaInicio);
                                    fechaLimite.setMonth(fechaLimite.getMonth() + 3);
                                    
                                    if (hoy <= fechaLimite) {
                                        cargaRol = 70; // 70% durante los primeros 3 meses
                                    }
                                }
                                
                                cargaTotal += cargaRol || 0;
                            }
                        }
                    });
                });
                return 100 - cargaTotal;
            };

            const estaBloqueado = (miembroId, proyectoId) => {
                const miembro = miembros.find(m => m.id === miembroId);
                if (!miembro) return { bloqueado: false };

                const asignacionNavegante = proyectos
                    .filter(p => p.id !== proyectoId && p.categoria === 'Semipermanente')
                    .find(p => p.asignaciones?.some(a => 
                        a.miembroId === miembroId && 
                        a.rol === 'Navegante de Ruta' && 
                        p.fechaInicio
                    ));

                if (asignacionNavegante) {
                    const fechaInicio = new Date(asignacionNavegante.fechaInicio);
                    const fechaDesbloqueo = new Date(fechaInicio);
                    fechaDesbloqueo.setMonth(fechaDesbloqueo.getMonth() + 3);
                    fechaDesbloqueo.setHours(0, 0, 0, 0);
                    const hoy = new Date();
                    hoy.setHours(0, 0, 0, 0);
                    
                    if (hoy < fechaDesbloqueo) {
                        return { 
                            bloqueado: true, 
                            razon: `Bloqueado como Navegante hasta ${fechaDesbloqueo.toLocaleDateString('es-MX')}`
                        };
                    }
                }

                const proyectosFinalizados = proyectos.filter(p => {
                    if (!p.fechaFin || !p.asignaciones?.some(a => a.miembroId === miembroId)) return false;
                    
                    const fechaFin = new Date(p.fechaFin);
                    fechaFin.setHours(0, 0, 0, 0);
                    const hoy = new Date();
                    hoy.setHours(0, 0, 0, 0);
                    
                    // Solo considerar si el proyecto YA finaliz√≥ (fechaFin < hoy)
                    return fechaFin < hoy;
                });

                for (const proyecto of proyectosFinalizados) {
                    const fechaFin = new Date(proyecto.fechaFin);
                    fechaFin.setHours(0, 0, 0, 0);
                    const diasDesbloqueo = new Date(fechaFin);
                    let diasContados = 0;
                    
                    while (diasContados < 5) {
                        diasDesbloqueo.setDate(diasDesbloqueo.getDate() + 1);
                        const diaSemana = diasDesbloqueo.getDay();
                        if (diaSemana !== 0 && diaSemana !== 6) diasContados++;
                    }
                    
                    const hoy = new Date();
                    hoy.setHours(0, 0, 0, 0);
                    
                    if (hoy < diasDesbloqueo) {
                        return { 
                            bloqueado: true, 
                            razon: `Bloqueado post-proyecto hasta ${diasDesbloqueo.toLocaleDateString('es-MX')}`
                        };
                    }
                }

                return { bloqueado: false };
            };

            const asignarMiembro = (itemId, rol, miembroId, esEntidad = false, porcentajePersonalizado = null) => {
                console.log('üîç asignarMiembro llamado:', { itemId, rol, miembroId, esEntidad, porcentajePersonalizado });
                
                const items = esEntidad ? entidades : proyectos;
                const setItems = esEntidad ? setEntidades : setProyectos;
                const item = items.find(p => p.id === itemId);
                const miembro = miembros.find(m => m.id === miembroId);
                
                if (!item || !miembro) return;

                const disponibilidad = calcularDisponibilidad(miembroId);
                const rolInfo = item.roles.find(r => r.nombre === rol);
                
                // Usar porcentaje personalizado si existe (incluso si es 0), sino usar rol o tipo
                const cargaRol = (porcentajePersonalizado !== null && porcentajePersonalizado !== undefined) 
                    ? porcentajePersonalizado 
                    : (rolInfo?.porcentaje || tiposIntervencion[rolInfo?.tipo] || 50);

                console.log('üìä Carga calculada:', { cargaRol, porcentajePersonalizado, 'rolInfo?.porcentaje': rolInfo?.porcentaje, 'tiposIntervencion[rolInfo?.tipo]': tiposIntervencion[rolInfo?.tipo] });

                if (disponibilidad - cargaRol < 10) {
                    alert('Este miembro exceder√≠a el 90% de carga permitida.');
                    return;
                }

                if (!esEntidad && item.categoria === 'Semipermanente') {
                    const bloqueo = estaBloqueado(miembroId, itemId);
                    if (bloqueo.bloqueado) {
                        alert(bloqueo.razon);
                        return;
                    }
                }

                setItems(items.map(p => {
                    if (p.id === itemId) {
                        const asignaciones = p.asignaciones || [];
                        if (asignaciones.some(a => a.rol === rol && a.miembroId === miembroId)) return p;
                        
                        // CR√çTICO: Guardar el porcentaje personalizado, no el fallback
                        const porcentajeAGuardar = (porcentajePersonalizado !== null && porcentajePersonalizado !== undefined) 
                            ? porcentajePersonalizado 
                            : (rolInfo?.porcentaje || tiposIntervencion[rolInfo?.tipo] || 50);
                        
                        console.log('üíæ Guardando asignaci√≥n con porcentaje:', porcentajeAGuardar);
                        
                        return { 
                            ...p, 
                            asignaciones: [...asignaciones, { 
                                rol, 
                                miembroId, 
                                porcentaje: porcentajeAGuardar,
                                fecha: new Date().toISOString() 
                            }] 
                        };
                    }
                    return p;
                }));
            };

            const desasignarMiembro = (itemId, rol, miembroId, esEntidad = false) => {
                const items = esEntidad ? entidades : proyectos;
                const setItems = esEntidad ? setEntidades : setProyectos;
                
                setItems(items.map(p => {
                    if (p.id === itemId) {
                        return { ...p, asignaciones: (p.asignaciones || []).filter(a => !(a.rol === rol && a.miembroId === miembroId)) };
                    }
                    return p;
                }));
            };

            const guardarMiembro = (miembro) => {
                if (miembro.id) {
                    setMiembros(miembros.map(m => m.id === miembro.id ? miembro : m));
                } else {
                    setMiembros([...miembros, { ...miembro, id: Date.now() }]);
                }
                setShowModalMiembro(false);
                setMiembroEdit(null);
            };

            const eliminarMiembro = (id) => {
                if (confirm('¬øEliminar este miembro?')) setMiembros(miembros.filter(m => m.id !== id));
            };

            const guardarProyecto = (proyecto) => {
                if (proyecto.id) {
                    setProyectos(proyectos.map(p => p.id === proyecto.id ? proyecto : p));
                } else {
                    setProyectos([...proyectos, { ...proyecto, id: Date.now(), asignaciones: [] }]);
                }
                setShowModalProyecto(false);
                setProyectoEdit(null);
            };

            const eliminarProyecto = (id) => {
                if (confirm('¬øEliminar esta rama/flor?')) setProyectos(proyectos.filter(p => p.id !== id));
            };

            // === GESTI√ìN DE RA√çCES/NUTRIENTES ===
            const guardarEntidad = (entidad) => {
                if (entidad.id) {
                    setEntidades(entidades.map(e => e.id === entidad.id ? entidad : e));
                } else {
                    setEntidades([...entidades, { ...entidad, id: Date.now(), asignaciones: [] }]);
                }
                setShowModalEntidad(false);
                setEntidadEdit(null);
            };

            const eliminarEntidad = (id) => {
                if (confirm('¬øEliminar esta ra√≠z/nutriente?')) setEntidades(entidades.filter(e => e.id !== id));
            };

            // === GESTI√ìN DE ROLES ===
            const obtenerTodosLosRoles = () => {
                const rolesSet = new Set();
                miembros.forEach(m => {
                    m.roles.forEach(r => rolesSet.add(r));
                });
                return Array.from(rolesSet).sort();
            };

            const obtenerMiembrosPorRol = (nombreRol) => {
                return miembros.filter(m => m.roles.includes(nombreRol));
            };

            const agregarRolAMiembro = (miembroId, nuevoRol) => {
                setMiembros(prevMiembros => prevMiembros.map(m => {
                    if (m.id === miembroId && !m.roles.includes(nuevoRol)) {
                        return { ...m, roles: [...m.roles, nuevoRol] };
                    }
                    return m;
                }));
            };

            const agregarRolAProyectoEntidad = (nombreRol, tipoIntervencion, nombreProyectoEntidad, porcentaje) => {
                if (!nombreProyectoEntidad) return; // Si no se seleccion√≥ nada, no hacer nada
                
                const nuevoRolObj = { nombre: nombreRol, tipo: tipoIntervencion };
                
                // Buscar en proyectos
                const proyecto = proyectos.find(p => p.nombre === nombreProyectoEntidad);
                if (proyecto) {
                    setProyectos(proyectos.map(p => {
                        if (p.nombre === nombreProyectoEntidad && !p.roles.some(r => r.nombre === nombreRol)) {
                            return { ...p, roles: [...p.roles, nuevoRolObj] };
                        }
                        return p;
                    }));
                    return;
                }
                
                // Buscar en entidades
                const entidad = entidades.find(e => e.nombre === nombreProyectoEntidad);
                if (entidad) {
                    setEntidades(entidades.map(e => {
                        if (e.nombre === nombreProyectoEntidad && !e.roles.some(r => r.nombre === nombreRol)) {
                            return { ...e, roles: [...e.roles, nuevoRolObj] };
                        }
                        return e;
                    }));
                }
            };

            const eliminarRolDeMiembro = (miembroId, rol) => {
                setMiembros(miembros.map(m => {
                    if (m.id === miembroId) {
                        return { ...m, roles: m.roles.filter(r => r !== rol) };
                    }
                    return m;
                }));
            };

            const renombrarRol = (rolAntiguo, rolNuevo) => {
                // Actualizar en miembros
                setMiembros(miembros.map(m => ({
                    ...m,
                    roles: m.roles.map(r => r === rolAntiguo ? rolNuevo : r)
                })));
                
                // Actualizar en proyectos
                setProyectos(proyectos.map(p => ({
                    ...p,
                    roles: p.roles.map(r => r.nombre === rolAntiguo ? { ...r, nombre: rolNuevo } : r),
                    asignaciones: p.asignaciones?.map(a => a.rol === rolAntiguo ? { ...a, rol: rolNuevo } : a)
                })));
                
                // Actualizar en entidades
                setEntidades(entidades.map(e => ({
                    ...e,
                    roles: e.roles.map(r => r.nombre === rolAntiguo ? { ...r, nombre: rolNuevo } : r),
                    asignaciones: e.asignaciones?.map(a => a.rol === rolAntiguo ? { ...a, rol: rolNuevo } : a)
                })));
            };

            const eliminarRol = (nombreRol) => {
                if (confirm(`¬øEliminar el rol "${nombreRol}"? Se remover√° de todos los miembros, proyectos y entidades.`)) {
                    // Eliminar de miembros
                    setMiembros(miembros.map(m => ({
                        ...m,
                        roles: m.roles.filter(r => r !== nombreRol)
                    })));
                    
                    // Eliminar de proyectos
                    setProyectos(proyectos.map(p => ({
                        ...p,
                        roles: p.roles.filter(r => r.nombre !== nombreRol),
                        asignaciones: p.asignaciones?.filter(a => a.rol !== nombreRol)
                    })));
                    
                    // Eliminar de entidades
                    setEntidades(entidades.map(e => ({
                        ...e,
                        roles: e.roles.filter(r => r.nombre !== nombreRol),
                        asignaciones: e.asignaciones?.filter(a => a.rol !== nombreRol)
                    })));
                }
            };

            const actualizarFechas = (itemId, fechaInicio, fechaFin, esEntidad = false) => {
                const items = esEntidad ? entidades : proyectos;
                const setItems = esEntidad ? setEntidades : setProyectos;
                setItems(items.map(p => p.id === itemId ? { ...p, fechaInicio, fechaFin } : p));
            };

            const nombresMenu = {
                'dashboard': 'Dashboard',
                'entidades': 'Ra√≠ces/Nutrientes',
                'proyectos': 'Ramas/Flores',
                'equipo': 'Equipo',
                'roles': 'Roles'
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
                    <header className="bg-white shadow-md">
                        <div className="max-w-7xl mx-auto px-4 py-6">
                            <h1 className="text-3xl font-bold text-indigo-900">
                                <i className="fas fa-project-diagram mr-3"></i>Gesti√≥n de Proyectos
                            </h1>
                            <p className="text-gray-600 mt-1">Optimiza la planificaci√≥n y asignaci√≥n de recursos</p>
                        </div>
                    </header>

                    <nav className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-4">
                            <div className="flex space-x-1">
                                {['dashboard', 'entidades', 'proyectos', 'equipo', 'roles'].map(vista => (
                                    <button
                                        key={vista}
                                        onClick={() => setVistaActual(vista)}
                                        className={`px-6 py-3 font-medium transition-colors ${
                                            vistaActual === vista
                                                ? 'text-indigo-600 border-b-2 border-indigo-600'
                                                : 'text-gray-600 hover:text-indigo-600'
                                        }`}
                                    >
                                        <i className={`fas fa-${
                                            vista === 'dashboard' ? 'th-large' :
                                            vista === 'entidades' ? 'building' :
                                            vista === 'proyectos' ? 'folder-open' : 
                                            vista === 'equipo' ? 'users' : 'tags'
                                        } mr-2`}></i>
                                        {nombresMenu[vista]}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-7xl mx-auto px-4 py-8">
                        {vistaActual === 'dashboard' && (
                            <Dashboard 
                                miembros={miembros} entidades={entidades} proyectos={proyectos}
                                calcularDisponibilidad={calcularDisponibilidad}
                            />
                        )}

                        {vistaActual === 'entidades' && (
                            <VistaItems
                                items={entidades} miembros={miembros}
                                tiposIntervencion={tiposIntervencion}
                                calcularDisponibilidad={calcularDisponibilidad}
                                asignarMiembro={asignarMiembro}
                                desasignarMiembro={desasignarMiembro}
                                actualizarFechas={actualizarFechas}
                                esEntidad={true}
                                titulo="Entidades"
                                onAgregar={() => { setEntidadEdit(null); setShowModalEntidad(true); }}
                                onEditar={(e) => { setEntidadEdit(e); setShowModalEntidad(true); }}
                                onEliminar={eliminarEntidad}
                            />
                        )}

                        {vistaActual === 'proyectos' && (
                            <VistaProyectos
                                proyectos={proyectos} miembros={miembros}
                                tiposIntervencion={tiposIntervencion}
                                calcularDisponibilidad={calcularDisponibilidad}
                                asignarMiembro={asignarMiembro}
                                desasignarMiembro={desasignarMiembro}
                                estaBloqueado={estaBloqueado}
                                onAgregarProyecto={() => { setProyectoEdit(null); setShowModalProyecto(true); }}
                                onEditarProyecto={(p) => { setProyectoEdit(p); setShowModalProyecto(true); }}
                                onEliminarProyecto={eliminarProyecto}
                                actualizarFechas={actualizarFechas}
                            />
                        )}

                        {vistaActual === 'equipo' && (
                            <VistaEquipo
                                miembros={miembros} proyectos={proyectos} entidades={entidades}
                                calcularDisponibilidad={calcularDisponibilidad}
                                onAgregarMiembro={() => { setMiembroEdit(null); setShowModalMiembro(true); }}
                                onEditarMiembro={(m) => { setMiembroEdit(m); setShowModalMiembro(true); }}
                                onEliminarMiembro={eliminarMiembro}
                            />
                        )}

                        {vistaActual === 'roles' && (
                            <VistaRoles
                                miembros={miembros}
                                proyectos={proyectos}
                                entidades={entidades}
                                obtenerTodosLosRoles={obtenerTodosLosRoles}
                                obtenerMiembrosPorRol={obtenerMiembrosPorRol}
                                agregarRolAMiembro={agregarRolAMiembro}
                                agregarRolAProyectoEntidad={agregarRolAProyectoEntidad}
                                eliminarRolDeMiembro={eliminarRolDeMiembro}
                                renombrarRol={renombrarRol}
                                eliminarRol={eliminarRol}
                                onAgregarRol={() => setShowModalRol(true)}
                            />
                        )}
                    </main>

                    {showModalMiembro && (
                        <ModalMiembro
                            miembro={miembroEdit}
                            obtenerTodosLosRoles={obtenerTodosLosRoles}
                            onGuardar={guardarMiembro}
                            onCerrar={() => { setShowModalMiembro(false); setMiembroEdit(null); }}
                        />
                    )}

                    {showModalProyecto && (
                        <ModalProyecto
                            proyecto={proyectoEdit}
                            miembros={miembros}
                            onGuardar={guardarProyecto}
                            onCerrar={() => { setShowModalProyecto(false); setProyectoEdit(null); }}
                        />
                    )}

                    {showModalEntidad && (
                        <ModalEntidad
                            entidad={entidadEdit}
                            miembros={miembros}
                            onGuardar={guardarEntidad}
                            onCerrar={() => { setShowModalEntidad(false); setEntidadEdit(null); }}
                        />
                    )}

                    {showModalRol && (
                        <ModalRol
                            miembros={miembros}
                            proyectos={proyectos}
                            entidades={entidades}
                            agregarRolAMiembro={agregarRolAMiembro}
                            agregarRolAProyectoEntidad={agregarRolAProyectoEntidad}
                            onCerrar={() => setShowModalRol(false)}
                        />
                    )}
                </div>
            );
        }

        function Dashboard({ miembros, entidades, proyectos, calcularDisponibilidad }) {
            const totalAsig = [...proyectos, ...entidades].reduce((acc, i) => acc + (i.asignaciones || []).length, 0);

            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                        {[
                            { icon: 'building', label: 'Ra√≠ces/Nutrientes', value: entidades.length, color: 'purple' },
                            { icon: 'folder', label: 'Ramas/Flores', value: proyectos.length, color: 'indigo' },
                            { icon: 'users', label: 'Equipo', value: miembros.length, color: 'green' },
                            { icon: 'tasks', label: 'Asignaciones', value: totalAsig, color: 'yellow' }
                        ].map(({ icon, label, value, color }) => (
                            <div key={label} className="bg-white rounded-lg shadow-md p-6">
                                <div className="flex items-center">
                                    <div className={`flex-shrink-0 bg-${color}-100 rounded-lg p-3`}>
                                        <i className={`fas fa-${icon} text-${color}-600 text-2xl`}></i>
                                    </div>
                                    <div className="ml-4">
                                        <p className="text-sm font-medium text-gray-600">{label}</p>
                                        <p className="text-2xl font-bold text-gray-900">{value}</p>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h3 className="text-lg font-bold text-gray-900 mb-4">
                            <i className="fas fa-building mr-2 text-purple-600"></i>Ra√≠ces/Nutrientes
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {entidades.map(entidad => (
                                <div key={entidad.id} className="p-4 bg-purple-50 rounded-lg">
                                    <h4 className="font-semibold text-gray-900">{entidad.nombre}</h4>
                                    <p className="text-sm text-gray-600">{(entidad.asignaciones || []).length} asignaciones</p>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {['Semipermanente', 'Radial', 'Transversal'].map(cat => {
                            const proysCat = proyectos.filter(p => p.categoria === cat);
                            return (
                                <div key={cat} className="bg-white rounded-lg shadow-md p-6">
                                    <h3 className="text-lg font-bold text-gray-900 mb-4">
                                        <i className="fas fa-tag mr-2 text-indigo-600"></i>{cat}
                                    </h3>
                                    {proysCat.length > 0 ? (
                                        <div className="space-y-3">
                                            {proysCat.map(p => (
                                                <div key={p.id} className="p-3 bg-gray-50 rounded-lg">
                                                    <p className="font-medium text-gray-900">{p.nombre}</p>
                                                    <p className="text-sm text-gray-600">{(p.asignaciones || []).length} asignaciones</p>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <p className="text-gray-500 text-center py-4">Sin ramas/flores</p>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        function VistaItems({ items, miembros, tiposIntervencion, calcularDisponibilidad, asignarMiembro, desasignarMiembro, actualizarFechas, esEntidad, titulo, onAgregar, onEditar, onEliminar }) {
            const [expandido, setExpandido] = useState(null);

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-gray-900">
                            <i className={`fas fa-${esEntidad ? 'building' : 'folder'} mr-2`}></i>{titulo}
                        </h2>
                        {onAgregar && (
                            <button 
                                onClick={onAgregar}
                                className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                            >
                                <i className="fas fa-plus mr-2"></i>Nueva Entidad
                            </button>
                        )}
                    </div>

                    {items.map(item => (
                        <ItemCard
                            key={item.id}
                            item={item}
                            miembros={miembros}
                            tiposIntervencion={tiposIntervencion}
                            calcularDisponibilidad={calcularDisponibilidad}
                            asignarMiembro={(rol, mId, porcentaje) => asignarMiembro(item.id, rol, mId, esEntidad, porcentaje)}
                            desasignarMiembro={(rol, mId) => desasignarMiembro(item.id, rol, mId, esEntidad)}
                            actualizarFechas={(fi, ff) => actualizarFechas(item.id, fi, ff, esEntidad)}
                            expandido={expandido === item.id}
                            setExpandido={() => setExpandido(expandido === item.id ? null : item.id)}
                            esEntidad={esEntidad}
                            onEditar={onEditar ? () => onEditar(item) : null}
                            onEliminar={onEliminar ? () => onEliminar(item.id) : null}
                        />
                    ))}
                </div>
            );
        }

        function ItemCard({ item, miembros, tiposIntervencion, calcularDisponibilidad, asignarMiembro, desasignarMiembro, actualizarFechas, expandido, setExpandido, esEntidad, onEditar, onEliminar }) {
            return (
                <div className="bg-white rounded-lg shadow-md">
                    <div className="p-6 border-b">
                        <div className="flex items-center justify-between">
                            <div className="flex-1">
                                <div className="flex items-center space-x-3">
                                    <h3 className="text-xl font-bold">{item.nombre}</h3>
                                    <span className="px-3 py-1 text-xs font-medium bg-purple-100 text-purple-800 rounded-full">
                                        {esEntidad ? 'Entidad' : item.categoria}
                                    </span>
                                </div>
                                <div className="mt-2 text-sm text-gray-600">
                                    <span><i className="fas fa-users mr-1"></i>{(item.asignaciones || []).length} asignaciones</span>
                                    <span className="ml-4"><i className="fas fa-briefcase mr-1"></i>{item.roles.length} roles</span>
                                </div>
                            </div>
                            <div className="flex items-center space-x-2">
                                {onEditar && (
                                    <button 
                                        onClick={onEditar}
                                        className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg"
                                        title="Editar"
                                    >
                                        <i className="fas fa-edit"></i>
                                    </button>
                                )}
                                {onEliminar && (
                                    <button 
                                        onClick={onEliminar}
                                        className="p-2 text-red-600 hover:bg-red-50 rounded-lg"
                                        title="Eliminar"
                                    >
                                        <i className="fas fa-trash"></i>
                                    </button>
                                )}
                                <button onClick={setExpandido} className="p-2 hover:bg-gray-100 rounded-lg">
                                    <i className={`fas fa-chevron-${expandido ? 'up' : 'down'}`}></i>
                                </button>
                            </div>
                        </div>

                        <div className="mt-4 grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Fecha Inicio</label>
                                <input
                                    type="date"
                                    value={item.fechaInicio || ''}
                                    onChange={(e) => actualizarFechas(e.target.value, item.fechaFin)}
                                    className="w-full px-3 py-2 border rounded-lg"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Fecha Fin</label>
                                <input
                                    type="date"
                                    value={item.fechaFin || ''}
                                    onChange={(e) => actualizarFechas(item.fechaInicio, e.target.value)}
                                    className="w-full px-3 py-2 border rounded-lg"
                                />
                            </div>
                        </div>
                    </div>

                    {expandido && (
                        <div className="p-6 bg-gray-50 space-y-4">
                            {item.roles.map((rol, idx) => (
                                <RolSection
                                    key={idx}
                                    rol={rol}
                                    item={item}
                                    miembros={miembros}
                                    tiposIntervencion={tiposIntervencion}
                                    calcularDisponibilidad={calcularDisponibilidad}
                                    asignarMiembro={asignarMiembro}
                                    desasignarMiembro={desasignarMiembro}
                                />
                            ))}
                            
                            {/* Mostrar asignaciones directas */}
                            {(() => {
                                const asignacionesDirectas = (item.asignaciones || []).filter(a => a.rol === 'Asignaci√≥n Directa');
                                if (asignacionesDirectas.length > 0) {
                                    return (
                                        <div className="border rounded-lg p-4 bg-white">
                                            <div className="flex items-center justify-between mb-3">
                                                <div className="flex items-center space-x-2">
                                                    <h4 className="font-semibold text-gray-900">Asignaciones Directas</h4>
                                                    <span className="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">
                                                        {asignacionesDirectas.length} miembro{asignacionesDirectas.length !== 1 ? 's' : ''}
                                                    </span>
                                                </div>
                                            </div>
                                            <div className="space-y-2">
                                                {asignacionesDirectas.map(asig => {
                                                    const miembro = miembros.find(m => m.id === asig.miembroId);
                                                    if (!miembro) return null;
                                                    const disponibilidad = calcularDisponibilidad(miembro.id);
                                                    return (
                                                        <div key={asig.miembroId} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                            <div className="flex-1">
                                                                <div className="flex items-center space-x-2">
                                                                    <span className="font-medium text-gray-900">{miembro.nombre}</span>
                                                                    <span className="text-xs px-2 py-1 bg-indigo-100 text-indigo-700 rounded">
                                                                        {asig.porcentaje}% de tiempo
                                                                    </span>
                                                                    <span className={`text-xs px-2 py-1 rounded ${
                                                                        disponibilidad >= 30 ? 'bg-green-100 text-green-700' :
                                                                        disponibilidad >= 10 ? 'bg-yellow-100 text-yellow-700' :
                                                                        'bg-red-100 text-red-700'
                                                                    }`}>
                                                                        {disponibilidad}% disponible
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <button
                                                                onClick={() => desasignarMiembro('Asignaci√≥n Directa', miembro.id)}
                                                                className="ml-3 text-red-600 hover:text-red-800"
                                                                title="Desasignar"
                                                            >
                                                                <i className="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    );
                                }
                                return null;
                            })()}
                        </div>
                    )}
                </div>
            );
        }

        function VistaProyectos({ proyectos, miembros, tiposIntervencion, calcularDisponibilidad, asignarMiembro, desasignarMiembro, estaBloqueado, onAgregarProyecto, onEditarProyecto, onEliminarProyecto, actualizarFechas }) {
            const [expandido, setExpandido] = useState(null);
            const [filtro, setFiltro] = useState('Todos');

            const proysFiltrados = filtro === 'Todos' ? proyectos : proyectos.filter(p => p.categoria === filtro);

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <div className="flex items-center space-x-4">
                            <label className="text-sm font-medium text-gray-700">Categor√≠a:</label>
                            <select value={filtro} onChange={(e) => setFiltro(e.target.value)} className="px-4 py-2 border rounded-lg">
                                {['Todos', 'Semipermanente', 'Radial', 'Transversal'].map(c => (
                                    <option key={c}>{c}</option>
                                ))}
                            </select>
                        </div>
                        <button onClick={onAgregarProyecto} className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                            <i className="fas fa-plus mr-2"></i>Nuevo Proyecto
                        </button>
                    </div>

                    {proysFiltrados.map(p => (
                        <ProyectoCard
                            key={p.id}
                            proyecto={p}
                            miembros={miembros}
                            tiposIntervencion={tiposIntervencion}
                            calcularDisponibilidad={calcularDisponibilidad}
                            asignarMiembro={(rol, mId) => asignarMiembro(p.id, rol, mId, false)}
                            desasignarMiembro={(rol, mId) => desasignarMiembro(p.id, rol, mId, false)}
                            estaBloqueado={estaBloqueado}
                            actualizarFechas={(fi, ff) => actualizarFechas(p.id, fi, ff, false)}
                            expandido={expandido === p.id}
                            setExpandido={() => setExpandido(expandido === p.id ? null : p.id)}
                            onEditar={() => onEditarProyecto(p)}
                            onEliminar={() => onEliminarProyecto(p.id)}
                        />
                    ))}

                    {proysFiltrados.length === 0 && (
                        <div className="text-center py-12 bg-white rounded-lg shadow-md">
                            <i className="fas fa-folder-open text-gray-400 text-5xl mb-4"></i>
                            <p className="text-gray-600">No hay proyectos</p>
                        </div>
                    )}
                </div>
            );
        }

        function ProyectoCard({ proyecto, miembros, tiposIntervencion, calcularDisponibilidad, asignarMiembro, desasignarMiembro, estaBloqueado, actualizarFechas, expandido, setExpandido, onEditar, onEliminar }) {
            const esSemi = proyecto.categoria === 'Semipermanente';

            return (
                <div className="bg-white rounded-lg shadow-md">
                    <div className="p-6 border-b">
                        <div className="flex items-center justify-between">
                            <div className="flex-1">
                                <div className="flex items-center space-x-3">
                                    <h3 className="text-xl font-bold">{proyecto.nombre}</h3>
                                    <span className="px-3 py-1 text-xs font-medium bg-indigo-100 text-indigo-800 rounded-full">
                                        {proyecto.categoria}
                                    </span>
                                </div>
                                <div className="mt-2 text-sm text-gray-600">
                                    <span><i className="fas fa-users mr-1"></i>{(proyecto.asignaciones || []).length} asignaciones</span>
                                    <span className="ml-4"><i className="fas fa-briefcase mr-1"></i>{proyecto.roles.length} roles</span>
                                </div>
                            </div>
                            <div className="flex items-center space-x-2">
                                {!esSemi && (
                                    <>
                                        <button onClick={onEditar} className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg">
                                            <i className="fas fa-edit"></i>
                                        </button>
                                        <button onClick={onEliminar} className="p-2 text-red-600 hover:bg-red-50 rounded-lg">
                                            <i className="fas fa-trash"></i>
                                        </button>
                                    </>
                                )}
                                <button onClick={setExpandido} className="p-2 hover:bg-gray-100 rounded-lg">
                                    <i className={`fas fa-chevron-${expandido ? 'up' : 'down'}`}></i>
                                </button>
                            </div>
                        </div>

                        <div className="mt-4 grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Fecha Inicio</label>
                                <input
                                    type="date"
                                    value={proyecto.fechaInicio || ''}
                                    onChange={(e) => actualizarFechas(e.target.value, proyecto.fechaFin)}
                                    className="w-full px-3 py-2 border rounded-lg"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Fecha Fin</label>
                                <input
                                    type="date"
                                    value={proyecto.fechaFin || ''}
                                    onChange={(e) => actualizarFechas(proyecto.fechaInicio, e.target.value)}
                                    className="w-full px-3 py-2 border rounded-lg"
                                />
                            </div>
                        </div>
                    </div>

                    {expandido && (
                        <div className="p-6 bg-gray-50 space-y-4">
                            {proyecto.roles.map((rol, idx) => (
                                <RolSection
                                    key={idx}
                                    rol={rol}
                                    item={proyecto}
                                    miembros={miembros}
                                    tiposIntervencion={tiposIntervencion}
                                    calcularDisponibilidad={calcularDisponibilidad}
                                    asignarMiembro={asignarMiembro}
                                    desasignarMiembro={desasignarMiembro}
                                    estaBloqueado={(mId) => estaBloqueado(mId, proyecto.id)}
                                />
                            ))}
                            
                            {/* Mostrar asignaciones directas */}
                            {(() => {
                                const asignacionesDirectas = (proyecto.asignaciones || []).filter(a => a.rol === 'Asignaci√≥n Directa');
                                if (asignacionesDirectas.length > 0) {
                                    return (
                                        <div className="border rounded-lg p-4 bg-white">
                                            <div className="flex items-center justify-between mb-3">
                                                <div className="flex items-center space-x-2">
                                                    <h4 className="font-semibold text-gray-900">Asignaciones Directas</h4>
                                                    <span className="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">
                                                        {asignacionesDirectas.length} miembro{asignacionesDirectas.length !== 1 ? 's' : ''}
                                                    </span>
                                                </div>
                                            </div>
                                            <div className="space-y-2">
                                                {asignacionesDirectas.map(asig => {
                                                    const miembro = miembros.find(m => m.id === asig.miembroId);
                                                    if (!miembro) return null;
                                                    const disponibilidad = calcularDisponibilidad(miembro.id);
                                                    return (
                                                        <div key={asig.miembroId} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                            <div className="flex-1">
                                                                <div className="flex items-center space-x-2">
                                                                    <span className="font-medium text-gray-900">{miembro.nombre}</span>
                                                                    <span className="text-xs px-2 py-1 bg-indigo-100 text-indigo-700 rounded">
                                                                        {asig.porcentaje}% de tiempo
                                                                    </span>
                                                                    <span className={`text-xs px-2 py-1 rounded ${
                                                                        disponibilidad >= 30 ? 'bg-green-100 text-green-700' :
                                                                        disponibilidad >= 10 ? 'bg-yellow-100 text-yellow-700' :
                                                                        'bg-red-100 text-red-700'
                                                                    }`}>
                                                                        {disponibilidad}% disponible
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <button
                                                                onClick={() => desasignarMiembro('Asignaci√≥n Directa', miembro.id)}
                                                                className="ml-3 text-red-600 hover:text-red-800"
                                                                title="Desasignar"
                                                            >
                                                                <i className="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    );
                                }
                                return null;
                            })()}
                        </div>
                    )}
                </div>
            );
        }

        function RolSection({ rol, item, miembros, tiposIntervencion, calcularDisponibilidad, asignarMiembro, desasignarMiembro, estaBloqueado }) {
            const [expandido, setExpandido] = useState(false);
            const [porcentajePersonalizado, setPorcentajePersonalizado] = useState({});
            const asignados = (item.asignaciones || []).filter(a => a.rol === rol.nombre);
            const disponibles = miembros.filter(m => m.roles.includes(rol.nombre) && !asignados.some(a => a.miembroId === m.id));

            const getPorcentajeSugerido = () => {
                return rol.porcentaje || tiposIntervencion[rol.tipo] || 50;
            };

            const getPorcentajeParaMiembro = (miembroId) => {
                return porcentajePersonalizado[miembroId] !== undefined 
                    ? porcentajePersonalizado[miembroId] 
                    : getPorcentajeSugerido();
            };

            const setPorcentajeParaMiembro = (miembroId, porcentaje) => {
                const porcentajeNumero = Number(porcentaje);
                console.log('üìù setPorcentajeParaMiembro:', { miembroId, porcentaje, porcentajeNumero, type: typeof porcentajeNumero });
                setPorcentajePersonalizado({
                    ...porcentajePersonalizado,
                    [miembroId]: porcentajeNumero
                });
            };

            const handleAsignar = (miembroId) => {
                const porcentaje = Number(getPorcentajeParaMiembro(miembroId));
                console.log('üéØ handleAsignar:', { miembroId, porcentaje, type: typeof porcentaje, 'porcentajePersonalizado[miembroId]': porcentajePersonalizado[miembroId], 'sugerido': getPorcentajeSugerido() });
                asignarMiembro(rol.nombre, miembroId, porcentaje);
                // Limpiar el porcentaje personalizado despu√©s de asignar
                const newPorcentajes = { ...porcentajePersonalizado };
                delete newPorcentajes[miembroId];
                setPorcentajePersonalizado(newPorcentajes);
            };

            return (
                <div className="bg-white rounded-lg p-4 border">
                    <div 
                        className="flex items-center justify-between cursor-pointer"
                        onClick={() => setExpandido(!expandido)}
                    >
                        <div className="flex-1">
                            <h4 className="font-semibold text-gray-900">{rol.nombre}</h4>
                            <div className="flex items-center space-x-2 mt-1">
                                <span className={`px-2 py-1 text-xs font-medium rounded ${
                                    rol.tipo === 'Obligatorio' ? 'bg-red-100 text-red-800' :
                                    rol.tipo === 'Esencial' ? 'bg-yellow-100 text-yellow-800' :
                                    rol.tipo === 'Capa Central' ? 'bg-blue-100 text-blue-800' :
                                    rol.tipo === 'Hub de crecimiento' ? 'bg-purple-100 text-purple-800' :
                                    'bg-green-100 text-green-800'
                                }`}>{rol.tipo}</span>
                                <span style={{display: "none"}} className="text-xs text-gray-600">{rol.porcentaje || tiposIntervencion[rol.tipo]}% de tiempo</span>
                                {asignados.length > 0 && (
                                    <span className="text-xs text-indigo-600 font-medium">
                                        {asignados.length} asignado{asignados.length !== 1 ? 's' : ''}
                                    </span>
                                )}
                            </div>
                        </div>
                        <i className={`fas fa-chevron-${expandido ? 'up' : 'down'} text-gray-400`}></i>
                    </div>

                    {expandido && (
                        <div className="mt-4 space-y-3">
                            {asignados.length > 0 && (
                                <div>
                                    <p className="text-sm font-medium text-gray-700 mb-2">Asignados:</p>
                                    <div className="space-y-2">
                                        {asignados.map((asig, i) => {
                                            const m = miembros.find(mm => mm.id === asig.miembroId);
                                            if (!m) return null;
                                            const disp = calcularDisponibilidad(m.id);
                                            const porcentajeAsignado = asig.porcentaje || rol.porcentaje || tiposIntervencion[rol.tipo];
                                            return (
                                                <div key={i} className="flex items-center justify-between p-2 bg-indigo-50 rounded-lg">
                                                    <div className="flex items-center space-x-2">
                                                        <span className="font-medium text-gray-900">{m.nombre}</span>
                                                        <span className="text-xs px-2 py-1 bg-indigo-200 text-indigo-900 rounded">
                                                            {porcentajeAsignado}% de tiempo
                                                        </span>
                                                        <span className="text-xs text-gray-600">({disp}% disponible)</span>
                                                    </div>
                                                    <button onClick={() => desasignarMiembro(rol.nombre, m.id)} className="text-red-600 hover:text-red-800">
                                                        <i className="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {disponibles.length > 0 && (
                                <div>
                                    <p className="text-sm font-medium text-gray-700 mb-2">Disponibles:</p>
                                    <div className="space-y-2">
                                        {disponibles.map(m => {
                                            const disp = calcularDisponibilidad(m.id);
                                            const bloqueo = estaBloqueado ? estaBloqueado(m.id) : { bloqueado: false };
                                            const puede = !bloqueo.bloqueado && disp - tiposIntervencion[rol.tipo] >= 10;

                                            return (
                                                <div key={m.id} className="p-2 bg-gray-100 rounded-lg">
                                                    <div className="flex items-center justify-between mb-2">
                                                        <div className="flex-1">
                                                            <div className="flex items-center space-x-2">
                                                                <span className="font-medium text-gray-900">{m.nombre}</span>
                                                                <span className={`text-xs ${
                                                                    disp >= 50 ? 'text-green-600' :
                                                                    disp >= 30 ? 'text-yellow-600' : 'text-red-600'
                                                                }`}>{disp}% disponible</span>
                                                            </div>
                                                            {bloqueo.bloqueado && (
                                                                <p className="text-xs text-red-600 mt-1">
                                                                    <i className="fas fa-lock mr-1"></i>{bloqueo.razon}
                                                                </p>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center space-x-2">
                                                        <span className="text-xs text-gray-600 whitespace-nowrap">Tiempo:</span>
                                                        <input
                                                            type="number"
                                                            min="1"
                                                            max="100"
                                                            value={getPorcentajeParaMiembro(m.id)}
                                                            onChange={(e) => setPorcentajeParaMiembro(m.id, parseInt(e.target.value) || 0)}
                                                            className="w-16 px-2 py-1 border rounded text-sm text-center"
                                                            onClick={(e) => e.stopPropagation()}
                                                        />
                                                        <span className="text-xs text-gray-600">%</span>
                                                        <button
                                                            onClick={(e) => { e.stopPropagation(); handleAsignar(m.id); }}
                                                            disabled={!puede}
                                                            className={`flex-1 px-3 py-1 rounded-lg text-sm font-medium ${
                                                                puede ? 'bg-indigo-600 text-white hover:bg-indigo-700' :
                                                                'bg-gray-300 text-gray-500 cursor-not-allowed'
                                                            }`}
                                                        >
                                                            Asignar
                                                        </button>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {asignados.length === 0 && disponibles.length === 0 && (
                                <p className="text-sm text-gray-500 italic">No hay miembros disponibles para este rol</p>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        function VistaEquipo({ miembros, proyectos, entidades, calcularDisponibilidad, onAgregarMiembro, onEditarMiembro, onEliminarMiembro }) {
            const [busq, setBusq] = useState('');
            const [ord, setOrd] = useState('nombre');

            let mFilt = miembros.filter(m => m.nombre.toLowerCase().includes(busq.toLowerCase()));
            if (ord === 'nombre') mFilt.sort((a, b) => a.nombre.localeCompare(b.nombre));
            else if (ord === 'disponibilidad') mFilt.sort((a, b) => calcularDisponibilidad(b.id) - calcularDisponibilidad(a.id));
            else mFilt.sort((a, b) => (100 - calcularDisponibilidad(a.id)) - (100 - calcularDisponibilidad(b.id)));

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center gap-4">
                        <div className="flex items-center space-x-4 flex-1">
                            <div className="relative flex-1 max-w-md">
                                <input
                                    type="text"
                                    placeholder="Buscar..."
                                    value={busq}
                                    onChange={(e) => setBusq(e.target.value)}
                                    className="w-full pl-10 pr-4 py-2 border rounded-lg"
                                />
                                <i className="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            </div>
                            <select value={ord} onChange={(e) => setOrd(e.target.value)} className="px-4 py-2 border rounded-lg">
                                <option value="nombre">Por Nombre</option>
                                <option value="disponibilidad">Mayor Disponibilidad</option>
                                <option value="carga">Mayor Carga</option>
                            </select>
                        </div>
                        <button onClick={onAgregarMiembro} className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                            <i className="fas fa-user-plus mr-2"></i>Nuevo Miembro
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {mFilt.map(m => {
                            const disp = calcularDisponibilidad(m.id);
                            const carga = 100 - disp;
                            const asig = [...proyectos, ...entidades].reduce((acc, i) => 
                                acc + (i.asignaciones || []).filter(a => a.miembroId === m.id).length, 0
                            );

                            return (
                                <div key={m.id} className="bg-white rounded-lg shadow-md p-6">
                                    <div className="flex items-start justify-between mb-4">
                                        <div className="flex-1">
                                            <h3 className="text-lg font-bold text-gray-900">{m.nombre}</h3>
                                            <p className="text-sm text-gray-600">{m.roles.length} roles</p>
                                        </div>
                                        <div className="flex space-x-2">
                                            <button onClick={() => onEditarMiembro(m)} className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg">
                                                <i className="fas fa-edit"></i>
                                            </button>
                                            <button onClick={() => onEliminarMiembro(m.id)} className="p-2 text-red-600 hover:bg-red-50 rounded-lg">
                                                <i className="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div className="mb-4">
                                        <div className="flex justify-between text-sm mb-1">
                                            <span className="font-medium">Disponibilidad</span>
                                            <span className={`font-bold ${
                                                disp >= 50 ? 'text-green-600' :
                                                disp >= 30 ? 'text-yellow-600' : 'text-red-600'
                                            }`}>{disp}%</span>
                                        </div>
                                        <div className="w-full bg-gray-200 rounded-full h-3">
                                            <div
                                                className={`h-3 rounded-full ${
                                                    disp >= 50 ? 'bg-green-500' :
                                                    disp >= 30 ? 'bg-yellow-500' : 'bg-red-500'
                                                }`}
                                                style={{ width: `${disp}%` }}
                                            ></div>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-3 mb-4">
                                        <div className="bg-indigo-50 rounded-lg p-3">
                                            <p className="text-xs text-gray-600">Carga</p>
                                            <p className="text-lg font-bold text-indigo-900">{carga}%</p>
                                        </div>
                                        <div className="bg-purple-50 rounded-lg p-3">
                                            <p className="text-xs text-gray-600">Asignaciones</p>
                                            <p className="text-lg font-bold text-purple-900">{asig}</p>
                                        </div>
                                    </div>

                                    <div>
                                        <p className="text-sm font-medium text-gray-700 mb-2">Roles:</p>
                                        <div className="flex flex-wrap gap-2">
                                            {m.roles.slice(0, 3).map((r, i) => (
                                                <span key={i} className="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded">{r}</span>
                                            ))}
                                            {m.roles.length > 3 && (
                                                <span className="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded">
                                                    +{m.roles.length - 3} m√°s
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {mFilt.length === 0 && (
                        <div className="text-center py-12 bg-white rounded-lg shadow-md">
                            <i className="fas fa-users text-gray-400 text-5xl mb-4"></i>
                            <p className="text-gray-600">No se encontraron miembros</p>
                        </div>
                    )}
                </div>
            );
        }

        function VistaRoles({ miembros, proyectos, entidades, obtenerTodosLosRoles, obtenerMiembrosPorRol, agregarRolAMiembro, agregarRolAProyectoEntidad, eliminarRolDeMiembro, renombrarRol, eliminarRol, onAgregarRol }) {
            const [busq, setBusq] = useState('');
            const [rolExpandido, setRolExpandido] = useState(null);
            const [editandoRol, setEditandoRol] = useState(null);
            const [nuevoNombreRol, setNuevoNombreRol] = useState('');
            const [vinculandoRol, setVinculandoRol] = useState(null);
            const [proyectoVinculacion, setProyectoVinculacion] = useState('');
            const [tipoVinculacion, setTipoVinculacion] = useState('Obligatorio');
            
            const roles = obtenerTodosLosRoles();
            const rolesFiltrados = roles.filter(r => r.toLowerCase().includes(busq.toLowerCase()));

            const toggleRol = (rol) => {
                setRolExpandido(rolExpandido === rol ? null : rol);
            };

            const iniciarEdicion = (rol) => {
                setEditandoRol(rol);
            };

            const cancelarEdicion = () => {
                setEditandoRol(null);
            };

            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-gray-900">
                            <i className="fas fa-tags mr-2"></i>Gesti√≥n de Roles
                        </h2>
                        <button
                            onClick={onAgregarRol}
                            className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
                        >
                            <i className="fas fa-plus mr-2"></i>Nuevo Rol
                        </button>
                    </div>

                    <div className="mb-6">
                        <div className="relative">
                            <i className="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            <input
                                type="text"
                                placeholder="Buscar rol..."
                                value={busq}
                                onChange={(e) => setBusq(e.target.value)}
                                className="w-full pl-10 pr-4 py-2 border rounded-lg"
                            />
                        </div>
                    </div>

                    <div className="grid grid-cols-1 gap-4">
                        {rolesFiltrados.map(rol => {
                            const miembrosConRol = obtenerMiembrosPorRol(rol);
                            const expandido = rolExpandido === rol;

                            return (
                                <div key={rol} className="bg-white rounded-lg shadow-md overflow-hidden">
                                    <div className="p-4">
                                        <div className="flex items-center justify-between">
                                            <div className="flex-1 flex items-center space-x-4">
                                                {editandoRol === rol ? (
                                                    <input
                                                        type="text"
                                                        value={nuevoNombreRol}
                                                        onChange={(e) => setNuevoNombreRol(e.target.value)}
                                                        className="px-3 py-1 border rounded-lg flex-1"
                                                        autoFocus
                                                        onKeyPress={(e) => e.key === 'Enter' && guardarEdicion()}
                                                    />
                                                ) : (
                                                    <>
                                                        <button
                                                            onClick={() => toggleRol(rol)}
                                                            className="flex-1 text-left"
                                                        >
                                                            <h3 className="text-lg font-semibold text-gray-900">{rol}</h3>
                                                            <p className="text-sm text-gray-600">
                                                                {miembrosConRol.length} miembro{miembrosConRol.length !== 1 ? 's' : ''}
                                                            </p>
                                                        </button>
                                                    </>
                                                )}
                                            </div>
                                            
                                            <div className="flex items-center space-x-2">
                                                <button
                                                    onClick={() => iniciarEdicion(rol)}
                                                    className="p-2 text-blue-600 hover:bg-blue-50 rounded"
                                                    title="Editar rol"
                                                >
                                                    <i className="fas fa-edit"></i>
                                                </button>
                                                <button
                                                    onClick={() => eliminarRol(rol)}
                                                    className="p-2 text-red-600 hover:bg-red-50 rounded"
                                                    title="Eliminar rol"
                                                >
                                                    <i className="fas fa-trash"></i>
                                                </button>
                                                <button
                                                    onClick={() => toggleRol(rol)}
                                                    className="p-2 text-gray-600 hover:bg-gray-50 rounded"
                                                >
                                                    <i className={`fas fa-chevron-${expandido ? 'up' : 'down'}`}></i>
                                                </button>
                                            </div>
                                        </div>

                                        {expandido && (
                                            <div className="mt-4 pt-4 border-t">
                                                {miembrosConRol.length > 0 ? (
                                                    <div className="space-y-2">
                                                        {miembrosConRol.map(m => (
                                                            <div key={m.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                                <span className="font-medium text-gray-900">{m.nombre}</span>
                                                                <button
                                                                    onClick={() => eliminarRolDeMiembro(m.id, rol)}
                                                                    className="px-3 py-1 text-sm text-red-600 hover:bg-red-50 rounded"
                                                                >
                                                                    <i className="fas fa-times mr-1"></i>Quitar rol
                                                                </button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <p className="text-gray-500 italic text-center py-4">
                                                        No hay miembros con este rol
                                                    </p>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {rolesFiltrados.length === 0 && (
                        <div className="text-center py-12 bg-white rounded-lg shadow-md">
                            <i className="fas fa-tags text-gray-400 text-5xl mb-4"></i>
                            <p className="text-gray-600">No se encontraron roles</p>
                        </div>
                    )}

                    {editandoRol && (
                        <ModalEditarRol
                            rol={editandoRol}
                            miembros={miembros}
                            proyectos={proyectos}
                            entidades={entidades}
                            obtenerMiembrosPorRol={obtenerMiembrosPorRol}
                            agregarRolAMiembro={agregarRolAMiembro}
                            agregarRolAProyectoEntidad={agregarRolAProyectoEntidad}
                            eliminarRolDeMiembro={eliminarRolDeMiembro}
                            onCerrar={cancelarEdicion}
                        />
                    )}
                </div>
            );
        }

        function ModalEditarRol({ rol, miembros, proyectos, entidades, obtenerMiembrosPorRol, agregarRolAMiembro, agregarRolAProyectoEntidad, eliminarRolDeMiembro, onCerrar }) {
            const [proyectoSeleccionado, setProyectoSeleccionado] = useState('');
            const [tipoIntervencion, setTipoIntervencion] = useState('Obligatorio');
            const [porcentaje, setPorcentaje] = useState(50);
            const [miembroSeleccionado, setMiembroSeleccionado] = useState('');
            
            const porcentajesDefault = {
                'Obligatorio': 50,
                'Esencial': 40,
                'Polinizador': 20,
                'Capa Central': 30,
                'Hub de crecimiento': 30,
                'Complementario': 30,
                'Contribuyente Clave': 40,
                'Especialista Activable': 30
            };

            
            const miembrosConRol = obtenerMiembrosPorRol(rol);
            const miembrosSinRol = miembros.filter(m => !m.roles.includes(rol));
            
            // Obtener proyectos/entidades donde ya est√° el rol
            const proyectosConRol = proyectos.filter(p => p.roles?.some(r => r.nombre === rol));
            const entidadesConRol = entidades.filter(e => e.roles?.some(r => r.nombre === rol));
            
            const agregarAProyecto = () => {
                if (proyectoSeleccionado) {
                    agregarRolAProyectoEntidad(rol, tipoIntervencion, proyectoSeleccionado, porcentaje);
                    setProyectoSeleccionado('');
                }
            };
            
            const agregarAMiembro = () => {
                if (miembroSeleccionado) {
                    agregarRolAMiembro(parseInt(miembroSeleccionado), rol);
                    setMiembroSeleccionado('');
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-2xl font-bold">Editar Rol: "{rol}"</h2>
                                <button onClick={onCerrar} className="text-gray-400 hover:text-gray-600">
                                    <i className="fas fa-times text-xl"></i>
                                </button>
                            </div>

                            <div className="space-y-6">
                                {/* Agregar a Proyecto/Entidad */}
                                <div className="border rounded-lg p-4">
                                    <h3 className="font-semibold text-lg mb-3">Agregar a Proyecto/Entidad</h3>
                                    <div className="space-y-3">
                                        <div>
                                            <select
                                                value={proyectoSeleccionado}
                                                onChange={(e) => setProyectoSeleccionado(e.target.value)}
                                                className="w-full px-4 py-2 border rounded-lg"
                                            >
                                                <option value="">-- Seleccionar Proyecto/Entidad --</option>
                                                <optgroup label="üìÅ RA√çCES/NUTRIENTES">
                                                    {entidades.map(e => (
                                                        <option key={`ent-${e.id}`} value={e.nombre}>{e.nombre}</option>
                                                    ))}
                                                </optgroup>
                                                <optgroup label="üìã RAMAS/FLORES SEMIPERMANENTES">
                                                    {proyectos.filter(p => p.categoria === 'Semipermanente').map(p => (
                                                        <option key={`proy-${p.id}`} value={p.nombre}>{p.nombre}</option>
                                                    ))}
                                                </optgroup>
                                                <optgroup label="üîµ RAMAS/FLORES RADIALES">
                                                    {proyectos.filter(p => p.categoria === 'Radial').map(p => (
                                                        <option key={`proy-${p.id}`} value={p.nombre}>{p.nombre}</option>
                                                    ))}
                                                </optgroup>
                                                <optgroup label="üî∂ RAMAS/FLORES TRANSVERSALES">
                                                    {proyectos.filter(p => p.categoria === 'Transversal').map(p => (
                                                        <option key={`proy-${p.id}`} value={p.nombre}>{p.nombre}</option>
                                                    ))}
                                                </optgroup>
                                            </select>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <select
                                                value={tipoIntervencion}
                                                onChange={(e) => setTipoIntervencion(e.target.value)}
                                                className="w-full px-4 py-2 border rounded-lg"
                                            >
                                                <option value="Obligatorio">Obligatorio</option>
                                                <option value="Esencial">Esencial</option>
                                                <option value="Polinizador">Polinizador</option>
                                                <option value="Capa Central">Capa Central</option>
                                                <option value="Hub de crecimiento">Hub de crecimiento</option>
                                                <option value="Complementario">Complementario</option>
                                                <option value="Contribuyente Clave">Contribuyente Clave</option>
                                                <option value="Especialista Activable">Especialista Activable</option>
                                            </select>
                                            <input style={{display: "none"}}
                                                type="number"
                                                min="1"
                                                max="100"
                                                value={porcentaje}
                                                onChange={(e) => setPorcentaje(parseInt(e.target.value) || 0)}
                                                className="w-full px-4 py-2 border rounded-lg"
                                                placeholder="Porcentaje %"
                                            />
                                        </div>
                                    </div>
                                    <button
                                        onClick={agregarAProyecto}
                                        disabled={!proyectoSeleccionado}
                                        className="mt-3 w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 disabled:bg-gray-300"
                                    >
                                        <i className="fas fa-plus mr-2"></i>Agregar a Proyecto/Entidad
                                    </button>

                                    {/* Mostrar donde est√° el rol */}
                                    {(proyectosConRol.length > 0 || entidadesConRol.length > 0) && (
                                        <div className="mt-3 p-3 bg-gray-50 rounded">
                                            <p className="text-sm font-medium text-gray-700 mb-2">Este rol est√° en:</p>
                                            <div className="flex flex-wrap gap-2">
                                                {entidadesConRol.map(e => (
                                                    <span key={`ec-${e.id}`} className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">
                                                        üìÅ {e.nombre}
                                                    </span>
                                                ))}
                                                {proyectosConRol.map(p => (
                                                    <span key={`pc-${p.id}`} className="px-2 py-1 bg-indigo-100 text-indigo-800 text-xs rounded">
                                                        üìã {p.nombre}
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Agregar a Miembros */}
                                <div className="border rounded-lg p-4">
                                    <h3 className="font-semibold text-lg mb-3">Agregar a Miembros</h3>
                                    <div className="flex gap-3">
                                        <select
                                            value={miembroSeleccionado}
                                            onChange={(e) => setMiembroSeleccionado(e.target.value)}
                                            className="flex-1 px-4 py-2 border rounded-lg"
                                        >
                                            <option value="">-- Seleccionar Miembro --</option>
                                            {miembrosSinRol.map(m => (
                                                <option key={m.id} value={m.id}>{m.nombre}</option>
                                            ))}
                                        </select>
                                        <button
                                            onClick={agregarAMiembro}
                                            disabled={!miembroSeleccionado}
                                            className="px-6 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-300"
                                        >
                                            <i className="fas fa-plus mr-2"></i>Agregar
                                        </button>
                                    </div>

                                    {/* Mostrar miembros con el rol */}
                                    {miembrosConRol.length > 0 && (
                                        <div className="mt-3">
                                            <p className="text-sm font-medium text-gray-700 mb-2">Miembros con este rol:</p>
                                            <div className="space-y-2">
                                                {miembrosConRol.map(m => (
                                                    <div key={m.id} className="flex items-center justify-between p-2 bg-gray-50 rounded">
                                                        <span>{m.nombre}</span>
                                                        <button
                                                            onClick={() => eliminarRolDeMiembro(m.id, rol)}
                                                            className="text-red-600 hover:text-red-800 text-sm"
                                                        >
                                                            <i className="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <button
                                    onClick={onCerrar}
                                    className="w-full bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400"
                                >
                                    Cerrar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function ModalRol({ miembros, proyectos, entidades, agregarRolAMiembro, agregarRolAProyectoEntidad, onCerrar }) {
            const [nuevoRol, setNuevoRol] = useState('');
            const [tipoIntervencion, setTipoIntervencion] = useState('Obligatorio');
            const [porcentaje, setPorcentaje] = useState(50);
            const [proyectoSeleccionado, setProyectoSeleccionado] = useState('');
            const [miembrosSeleccionados, setMiembrosSeleccionados] = useState([]);

            const porcentajesDefault = {
                'Obligatorio': 50,
                'Esencial': 40,
                'Polinizador': 20,
                'Capa Central': 30,
                'Hub de crecimiento': 30,
                'Complementario': 30,
                'Contribuyente Clave': 40,
                'Especialista Activable': 30
            };


            const toggleMiembro = (miembroId) => {
                if (miembrosSeleccionados.includes(miembroId)) {
                    setMiembrosSeleccionados(miembrosSeleccionados.filter(id => id !== miembroId));
                } else {
                    setMiembrosSeleccionados([...miembrosSeleccionados, miembroId]);
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!nuevoRol.trim()) {
                    alert('Ingrese un nombre para el rol');
                    return;
                }
                if (miembrosSeleccionados.length === 0) {
                    alert('Seleccione al menos un miembro');
                    return;
                }

                // Agregar rol a miembros
                miembrosSeleccionados.forEach(miembroId => {
                    agregarRolAMiembro(miembroId, nuevoRol.trim());
                });

                // Agregar rol al proyecto/entidad si fue seleccionado
                if (proyectoSeleccionado) {
                    agregarRolAProyectoEntidad(nuevoRol.trim(), tipoIntervencion, proyectoSeleccionado, porcentaje);
                }

                const proyectoInfo = proyectoSeleccionado ? ` - Ligado a: ${proyectoSeleccionado}` : '';
                alert(`Rol "${nuevoRol}" (${tipoIntervencion} - ${porcentaje}%) agregado a ${miembrosSeleccionados.length} miembro(s)${proyectoInfo}`);
                onCerrar();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="p-6">
                            <div className="flex justify-between mb-6">
                                <h2 className="text-2xl font-bold">Agregar Nuevo Rol</h2>
                                <button onClick={onCerrar} className="text-gray-400 hover:text-gray-600">
                                    <i className="fas fa-times text-xl"></i>
                                </button>
                            </div>

                            <form onSubmit={handleSubmit} className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium mb-2">Nombre del Rol</label>
                                    <input
                                        type="text"
                                        value={nuevoRol}
                                        onChange={(e) => setNuevoRol(e.target.value)}
                                        className="w-full px-4 py-2 border rounded-lg"
                                        placeholder="Ej: Coordinador de Marketing"
                                        required
                                    />
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Tipo de Intervenci√≥n</label>
                                        <select
                                            value={tipoIntervencion}
                                            onChange={(e) => setTipoIntervencion(e.target.value)}
                                            className="w-full px-4 py-2 border rounded-lg"
                                        >
                                            <option value="Obligatorio">Obligatorio</option>
                                            <option value="Esencial">Esencial</option>
                                            <option value="Polinizador">Polinizador</option>
                                            <option value="Capa Central">Capa Central</option>
                                            <option value="Hub de crecimiento">Hub de crecimiento</option>
                                            <option value="Complementario">Complementario</option>
                                                <option value="Contribuyente Clave">Contribuyente Clave</option>
                                                <option value="Especialista Activable">Especialista Activable</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Porcentaje de Tiempo (%)</label>
                                        <input style={{display: "none"}}
                                            type="number"
                                            min="1"
                                            max="100"
                                            value={porcentaje}
                                            onChange={(e) => setPorcentaje(parseInt(e.target.value) || 0)}
                                            className="w-full px-4 py-2 border rounded-lg"
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-2">Ligar a Proyecto/Entidad (Opcional)</label>
                                    <select
                                        value={proyectoSeleccionado}
                                        onChange={(e) => setProyectoSeleccionado(e.target.value)}
                                        className="w-full px-4 py-2 border rounded-lg"
                                    >
                                        <option value="">-- Ninguno --</option>
                                        
                                        <optgroup label="üìÅ RA√çCES/NUTRIENTES">
                                            {entidades.map(e => (
                                                <option key={`ent-${e.id}`} value={e.nombre}>
                                                    {e.nombre}
                                                </option>
                                            ))}
                                        </optgroup>

                                        <optgroup label="üìã RAMAS/FLORES SEMIPERMANENTES">
                                            {proyectos.filter(p => p.categoria === 'Semipermanente').map(p => (
                                                <option key={`proy-${p.id}`} value={p.nombre}>
                                                    {p.nombre}
                                                </option>
                                            ))}
                                        </optgroup>

                                        <optgroup label="üîµ RAMAS/FLORES RADIALES">
                                            {proyectos.filter(p => p.categoria === 'Radial').map(p => (
                                                <option key={`proy-${p.id}`} value={p.nombre}>
                                                    {p.nombre}
                                                </option>
                                            ))}
                                        </optgroup>

                                        <optgroup label="üî∂ RAMAS/FLORES TRANSVERSALES">
                                            {proyectos.filter(p => p.categoria === 'Transversal').map(p => (
                                                <option key={`proy-${p.id}`} value={p.nombre}>
                                                    {p.nombre}
                                                </option>
                                            ))}
                                        </optgroup>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-2">
                                        Seleccionar Miembros ({miembrosSeleccionados.length} seleccionados)
                                    </label>
                                    <div className="border rounded-lg max-h-96 overflow-y-auto">
                                        {miembros.map(m => (
                                            <div
                                                key={m.id}
                                                className="flex items-center p-3 hover:bg-gray-50 border-b last:border-b-0 cursor-pointer"
                                                onClick={() => toggleMiembro(m.id)}
                                            >
                                                <input
                                                    type="checkbox"
                                                    checked={miembrosSeleccionados.includes(m.id)}
                                                    onChange={() => {}}
                                                    className="mr-3"
                                                />
                                                <div className="flex-1">
                                                    <p className="font-medium text-gray-900">{m.nombre}</p>
                                                    <p className="text-sm text-gray-600">{m.roles.length} roles actuales</p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="flex space-x-4">
                                    <button
                                        type="submit"
                                        className="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 font-medium"
                                    >
                                        <i className="fas fa-plus mr-2"></i>Agregar Rol
                                    </button>
                                    <button
                                        type="button"
                                        onClick={onCerrar}
                                        className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 font-medium"
                                    >
                                        Cancelar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        function ModalMiembro({ miembro, obtenerTodosLosRoles, onGuardar, onCerrar }) {
            const [nombre, setNombre] = useState(miembro?.nombre || '');
            const [rolesSel, setRolesSel] = useState(miembro?.roles || []);

            const todosRoles = obtenerTodosLosRoles();

            const toggleRol = (r) => {
                setRolesSel(rolesSel.includes(r) ? rolesSel.filter(rr => rr !== r) : [...rolesSel, r]);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!nombre.trim() || rolesSel.length === 0) {
                    alert('Complete todos los campos');
                    return;
                }
                onGuardar({ id: miembro?.id, nombre: nombre.trim(), roles: rolesSel });
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="p-6">
                            <div className="flex justify-between mb-6">
                                <h2 className="text-2xl font-bold">{miembro ? 'Editar' : 'Nuevo'} Miembro</h2>
                                <button onClick={onCerrar} className="text-gray-400 hover:text-gray-600">
                                    <i className="fas fa-times text-xl"></i>
                                </button>
                            </div>

                            <form onSubmit={handleSubmit} className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium mb-2">Nombre</label>
                                    <input
                                        type="text"
                                        value={nombre}
                                        onChange={(e) => setNombre(e.target.value)}
                                        className="w-full px-4 py-2 border rounded-lg"
                                        required
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-2">
                                        Roles ({rolesSel.length} seleccionados)
                                    </label>
                                    <div className="border rounded-lg p-4 max-h-64 overflow-y-auto">
                                        {todosRoles.map(r => (
                                            <label key={r} className="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    checked={rolesSel.includes(r)}
                                                    onChange={() => toggleRol(r)}
                                                    className="w-4 h-4 text-indigo-600 rounded"
                                                />
                                                <span className="ml-3 text-sm">{r}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>

                                <div className="flex justify-end space-x-3 pt-4 border-t">
                                    <button type="button" onClick={onCerrar} className="px-6 py-2 border rounded-lg hover:bg-gray-50">
                                        Cancelar
                                    </button>
                                    <button type="submit" className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                                        {miembro ? 'Guardar' : 'Agregar'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        function ModalEntidad({ entidad, miembros, onGuardar, onCerrar }) {
            const [nombre, setNombre] = useState(entidad?.nombre || '');
            const [roles, setRoles] = useState(entidad?.roles || []);
            const [asignaciones, setAsignaciones] = useState(entidad?.asignaciones || []);
            const [miembroSeleccionado, setMiembroSeleccionado] = useState('');
            const [porcentajeAsignacion, setPorcentajeAsignacion] = useState(30);
            
            // Estados para agregar roles
            const [nuevoRol, setNuevoRol] = useState({ nombre: '', tipo: 'Capa Central' });
            
            const rolesDisp = [
                "Navegante de Ruta", "Arquitecto de Valor", "Programadores", "Guardi√°n de Calidad",
                "Growth Funnel Owner", "Dise√±ador UX/UI", "Modelador de Comportamiento", 
                "Catalizador de Ecosistema", "Especialista Conector Estrat√©gico",
                "Responsable de Datos y Aprendizaje Estrat√©gico", "Consultores/facilitadores",
                "Lider de especialidad", "Especialista en Vinculaci√≥n", "Estratega de Tracci√≥n Multicanal",
                "Gobernanza + Estrategia (Futuro)", "Finanzas y Compliance", "Posicionamiento",
                "Personas y Cultura", "Innovaci√≥n Tec", "Monetizaci√≥n", "Donantes",
                "Comercializador Empresa B", "Strategic Challenger"
            ];

            const porcentajesDefault = {
                'Obligatorio': 50,
                'Esencial': 40,
                'Polinizador': 20,
                'Capa Central': 30,
                'Hub de crecimiento': 30,
                'Complementario': 30,
                'Contribuyente Clave': 40,
                'Especialista Activable': 30
            };


            const agregarRol = () => {
                if (!nuevoRol.nombre) {
                    alert('Seleccione un rol');
                    return;
                }
                if (roles.some(r => r.nombre === nuevoRol.nombre)) {
                    alert('Rol ya agregado a esta entidad');
                    return;
                }
                setRoles([...roles, { nombre: nuevoRol.nombre, tipo: nuevoRol.tipo }]);
                setNuevoRol({ nombre: '', tipo: 'Capa Central' });
            };

            const eliminarRol = (index) => {
                setRoles(roles.filter((_, idx) => idx !== index));
            };

            const agregarAsignacion = () => {
                if (!miembroSeleccionado) {
                    alert('Seleccione un miembro');
                    return;
                }
                if (asignaciones.some(a => a.miembroId === parseInt(miembroSeleccionado))) {
                    alert('Miembro ya asignado');
                    return;
                }
                setAsignaciones([...asignaciones, { 
                    miembroId: parseInt(miembroSeleccionado), 
                    porcentaje: porcentajeAsignacion,
                    rol: 'Asignaci√≥n Directa' // Identificador especial
                }]);
                setMiembroSeleccionado('');
                setPorcentajeAsignacion(30);
            };

            const eliminarAsignacion = (miembroId) => {
                setAsignaciones(asignaciones.filter(a => a.miembroId !== miembroId));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!nombre.trim()) {
                    alert('Ingrese el nombre de la ra√≠z/nutriente');
                    return;
                }
                onGuardar({
                    id: entidad?.id,
                    nombre: nombre.trim(),
                    roles,
                    fechaInicio: entidad?.fechaInicio || null,
                    fechaFin: entidad?.fechaFin || null,
                    asignaciones: asignaciones
                });
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="p-6">
                            <div className="flex justify-between mb-6">
                                <h2 className="text-2xl font-bold">{entidad ? 'Editar' : 'Nueva'} Entidad</h2>
                                <button onClick={onCerrar} className="text-gray-400 hover:text-gray-600">
                                    <i className="fas fa-times text-xl"></i>
                                </button>
                            </div>

                            <form onSubmit={handleSubmit} className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium mb-2">Nombre de la Ra√≠z/Nutriente</label>
                                    <input
                                        type="text"
                                        value={nombre}
                                        onChange={(e) => setNombre(e.target.value)}
                                        className="w-full px-4 py-2 border rounded-lg"
                                        placeholder="Ej: N√∫cleo Operativo"
                                        required
                                    />
                                </div>

                                <div className="border-t pt-6">
                                    <h3 className="text-lg font-semibold mb-4">Roles de la Entidad (Opcional)</h3>
                                    <div className="space-y-4">
                                        <div className="space-y-3">
                                            <select
                                                value={nuevoRol.nombre}
                                                onChange={(e) => setNuevoRol({ ...nuevoRol, nombre: e.target.value })}
                                                className="w-full px-4 py-2 border rounded-lg"
                                            >
                                                <option value="">Seleccionar rol...</option>
                                                {rolesDisp.map(r => (
                                                    <option key={r} value={r}>{r}</option>
                                                ))}
                                            </select>
                                            <div className="flex space-x-3">
                                                <select
                                                    value={nuevoRol.tipo}
                                                    onChange={(e) => setNuevoRol({ ...nuevoRol, tipo: e.target.value })}
                                                    className="flex-1 px-4 py-2 border rounded-lg"
                                                >
                                                    <option value="Capa Central">Capa Central</option>
                                                    <option value="Hub de crecimiento">Hub de crecimiento</option>
                                                    <option value="Complementario">Complementario</option>
                                                    <option value="Obligatorio">Obligatorio</option>
                                                    <option value="Esencial">Esencial</option>
                                                    <option value="Contribuyente Clave">Contribuyente Clave</option>
                                                    <option value="Especialista Activable">Especialista Activable</option>
                                                    <option value="Polinizador">Polinizador</option>
                                                </select>
                                                <div style={{display: "none"}} className="flex items-center space-x-2">
                                                    <input
                                                        type="number"
                                                        min="1"
                                                        max="100"
                                                        value={nuevoRol.porcentaje}
                                                        onChange={(e) => setNuevoRol({ ...nuevoRol, porcentaje: parseInt(e.target.value) || 0 })}
                                                        className="w-20 px-3 py-2 border rounded-lg text-center"
                                                    />
                                                    <span className="text-sm text-gray-600">%</span>
                                                </div>
                                                <button
                                                    type="button"
                                                    onClick={agregarRol}
                                                    className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                                >
                                                    <i className="fas fa-plus mr-2"></i>Agregar
                                                </button>
                                            </div>
                                        </div>

                                        {roles.length > 0 && (
                                            <div className="border rounded-lg p-4">
                                                <p className="text-sm font-medium text-gray-700 mb-3">
                                                    Roles agregados ({roles.length})
                                                </p>
                                                <div className="space-y-2">
                                                    {roles.map((rol, idx) => (
                                                        <div key={idx} className="flex justify-between items-center p-2 bg-gray-50 rounded">
                                                            <div>
                                                                <span className="font-medium">{rol.nombre}</span>
                                                                <span className="ml-2 text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded">
                                                                    {rol.tipo}
                                                                </span>
                                                                <span style={{display: "none"}} className="ml-2 text-xs px-2 py-1 bg-green-100 text-green-800 rounded">
                                                                    {rol.porcentaje}%
                                                                </span>
                                                            </div>
                                                            <button
                                                                type="button"
                                                                onClick={() => eliminarRol(idx)}
                                                                className="text-red-600 hover:text-red-800"
                                                            >
                                                                <i className="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="border-t pt-6">
                                    <h3 className="text-lg font-semibold mb-4">Asignar Miembros del Equipo (Opcional)</h3>
                                    <div className="space-y-4">
                                        <div className="flex space-x-3">
                                            <select
                                                value={miembroSeleccionado}
                                                onChange={(e) => setMiembroSeleccionado(e.target.value)}
                                                className="flex-1 px-4 py-2 border rounded-lg"
                                            >
                                                <option value="">Seleccionar miembro...</option>
                                                {miembros?.map(m => (
                                                    <option key={m.id} value={m.id}>{m.nombre}</option>
                                                ))}
                                            </select>
                                            <div className="flex items-center space-x-2">
                                                <input
                                                    type="number"
                                                    min="1"
                                                    max="100"
                                                    value={porcentajeAsignacion}
                                                    onChange={(e) => setPorcentajeAsignacion(parseInt(e.target.value) || 0)}
                                                    className="w-20 px-3 py-2 border rounded-lg text-center"
                                                />
                                                <span className="text-sm text-gray-600">%</span>
                                            </div>
                                            <button
                                                type="button"
                                                onClick={agregarAsignacion}
                                                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                            >
                                                <i className="fas fa-plus mr-2"></i>Agregar
                                            </button>
                                        </div>

                                        {asignaciones.length > 0 && (
                                            <div className="border rounded-lg p-4">
                                                <p className="text-sm font-medium text-gray-700 mb-3">
                                                    Miembros asignados ({asignaciones.length})
                                                </p>
                                                <div className="space-y-2">
                                                    {asignaciones.map(asig => {
                                                        const miembro = miembros?.find(m => m.id === asig.miembroId);
                                                        return miembro ? (
                                                            <div key={asig.miembroId} className="flex justify-between items-center p-2 bg-gray-50 rounded">
                                                                <div>
                                                                    <span className="font-medium">{miembro.nombre}</span>
                                                                    <span className="ml-2 text-sm text-gray-600">
                                                                        ({asig.porcentaje}% de tiempo)
                                                                    </span>
                                                                </div>
                                                                <button
                                                                    type="button"
                                                                    onClick={() => eliminarAsignacion(asig.miembroId)}
                                                                    className="text-red-600 hover:text-red-800"
                                                                >
                                                                    <i className="fas fa-times"></i>
                                                                </button>
                                                            </div>
                                                        ) : null;
                                                    })}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="flex justify-end space-x-3 pt-4 border-t">
                                    <button type="button" onClick={onCerrar} className="px-6 py-2 border rounded-lg hover:bg-gray-50">
                                        Cancelar
                                    </button>
                                    <button type="submit" className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                                        {entidad ? 'Guardar' : 'Crear'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        function ModalProyecto({ proyecto, miembros, onGuardar, onCerrar }) {
            const [nombre, setNombre] = useState(proyecto?.nombre || '');
            const [cat, setCat] = useState(proyecto?.categoria || 'Radial');
            const [roles, setRoles] = useState(proyecto?.roles || []);
            const [asignaciones, setAsignaciones] = useState(proyecto?.asignaciones || []);
            const [miembroSeleccionado, setMiembroSeleccionado] = useState('');
            const [porcentajeAsignacion, setPorcentajeAsignacion] = useState(30);
            
            // Estados para agregar roles
            const [nuevoRol, setNuevoRol] = useState({ nombre: '', tipo: 'Obligatorio' });
            
            const rolesDisp = [
                "Navegante de Ruta", "Arquitecto de Valor", "Programadores", "Guardi√°n de Calidad",
                "Growth Funnel Owner", "Dise√±ador UX/UI", "Modelador de Comportamiento", 
                "Catalizador de Ecosistema", "Especialista Conector Estrat√©gico",
                "Responsable de Datos y Aprendizaje Estrat√©gico", "Consultores/facilitadores",
                "Lider de especialidad", "Especialista en Vinculaci√≥n", "Estratega de Tracci√≥n Multicanal",
                "Gobernanza + Estrategia (Futuro)", "Finanzas y Compliance", "Posicionamiento",
                "Personas y Cultura", "Innovaci√≥n Tec", "Monetizaci√≥n", "Donantes",
                "Comercializador Empresa B", "Strategic Challenger"
            ];

            const porcentajesDefault = {
                'Obligatorio': 50,
                'Esencial': 40,
                'Polinizador': 20,
                'Capa Central': 30,
                'Hub de crecimiento': 30,
                'Complementario': 30,
                'Contribuyente Clave': 40,
                'Especialista Activable': 30
            };


            const agregarRol = () => {
                if (!nuevoRol.nombre) {
                    alert('Seleccione un rol');
                    return;
                }
                if (roles.some(r => r.nombre === nuevoRol.nombre)) {
                    alert('Rol ya agregado a este proyecto');
                    return;
                }
                setRoles([...roles, { nombre: nuevoRol.nombre, tipo: nuevoRol.tipo }]);
                setNuevoRol({ nombre: '', tipo: 'Obligatorio' });
            };

            const eliminarRol = (index) => {
                setRoles(roles.filter((_, idx) => idx !== index));
            };

            const agregarAsignacion = () => {
                if (!miembroSeleccionado) {
                    alert('Seleccione un miembro');
                    return;
                }
                if (asignaciones.some(a => a.miembroId === parseInt(miembroSeleccionado))) {
                    alert('Miembro ya asignado');
                    return;
                }
                setAsignaciones([...asignaciones, { 
                    miembroId: parseInt(miembroSeleccionado), 
                    porcentaje: porcentajeAsignacion,
                    rol: 'Asignaci√≥n Directa' // Identificador especial
                }]);
                setMiembroSeleccionado('');
                setPorcentajeAsignacion(30);
            };

            const eliminarAsignacion = (miembroId) => {
                setAsignaciones(asignaciones.filter(a => a.miembroId !== miembroId));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!nombre.trim()) {
                    alert('Ingrese el nombre del proyecto');
                    return;
                }
                onGuardar({
                    id: proyecto?.id,
                    nombre: nombre.trim(),
                    categoria: cat,
                    roles,
                    fechaInicio: proyecto?.fechaInicio || null,
                    fechaFin: proyecto?.fechaFin || null,
                    asignaciones: asignaciones
                });
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="p-6">
                            <div className="flex justify-between mb-6">
                                <h2 className="text-2xl font-bold">{proyecto ? 'Editar' : 'Nuevo'} Proyecto</h2>
                                <button onClick={onCerrar} className="text-gray-400 hover:text-gray-600">
                                    <i className="fas fa-times text-xl"></i>
                                </button>
                            </div>

                            <form onSubmit={handleSubmit} className="space-y-6">
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Categor√≠a</label>
                                        <select value={cat} onChange={(e) => setCat(e.target.value)} className="w-full px-4 py-2 border rounded-lg">
                                            <option value="Semipermanente">Semipermanente</option>
                                            <option value="Radial">Radial</option>
                                            <option value="Transversal">Transversal</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Nombre</label>
                                        <input
                                            type="text"
                                            value={nombre}
                                            onChange={(e) => setNombre(e.target.value)}
                                            className="w-full px-4 py-2 border rounded-lg"
                                            required
                                        />
                                    </div>
                                </div>

                                <div className="border-t pt-6">
                                    <h3 className="text-lg font-semibold mb-4">Roles del Proyecto (Opcional)</h3>
                                    <div className="space-y-4">
                                        <div className="space-y-3">
                                            <select
                                                value={nuevoRol.nombre}
                                                onChange={(e) => setNuevoRol({ ...nuevoRol, nombre: e.target.value })}
                                                className="w-full px-4 py-2 border rounded-lg"
                                            >
                                                <option value="">Seleccionar rol...</option>
                                                {rolesDisp.map(r => (
                                                    <option key={r} value={r}>{r}</option>
                                                ))}
                                            </select>
                                            <div className="flex space-x-3">
                                                <select
                                                    value={nuevoRol.tipo}
                                                    onChange={(e) => setNuevoRol({ ...nuevoRol, tipo: e.target.value })}
                                                    className="flex-1 px-4 py-2 border rounded-lg"
                                                >
                                                    <option value="Obligatorio">Obligatorio</option>
                                                    <option value="Esencial">Esencial</option>
                                                    <option value="Contribuyente Clave">Contribuyente Clave</option>
                                                    <option value="Capa Central">Capa Central</option>
                                                    <option value="Hub de crecimiento">Hub de crecimiento</option>
                                                    <option value="Complementario">Complementario</option>
                                                    <option value="Especialista Activable">Especialista Activable</option>
                                                    <option value="Polinizador">Polinizador</option>
                                                </select>
                                                <div style={{display: "none"}} className="flex items-center space-x-2">
                                                    <input
                                                        type="number"
                                                        min="1"
                                                        max="100"
                                                        value={nuevoRol.porcentaje}
                                                        onChange={(e) => setNuevoRol({ ...nuevoRol, porcentaje: parseInt(e.target.value) || 0 })}
                                                        className="w-20 px-3 py-2 border rounded-lg text-center"
                                                    />
                                                    <span className="text-sm text-gray-600">%</span>
                                                </div>
                                                <button
                                                    type="button"
                                                    onClick={agregarRol}
                                                    className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                                >
                                                    <i className="fas fa-plus mr-2"></i>Agregar
                                                </button>
                                            </div>
                                        </div>

                                        {roles.length > 0 && (
                                            <div className="border rounded-lg p-4">
                                                <p className="text-sm font-medium text-gray-700 mb-3">
                                                    Roles agregados ({roles.length})
                                                </p>
                                                <div className="space-y-2">
                                                    {roles.map((rol, idx) => (
                                                        <div key={idx} className="flex justify-between items-center p-2 bg-gray-50 rounded">
                                                            <div>
                                                                <span className="font-medium">{rol.nombre}</span>
                                                                <span className="ml-2 text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded">
                                                                    {rol.tipo}
                                                                </span>
                                                                <span style={{display: "none"}} className="ml-2 text-xs px-2 py-1 bg-green-100 text-green-800 rounded">
                                                                    {rol.porcentaje}%
                                                                </span>
                                                            </div>
                                                            <button
                                                                type="button"
                                                                onClick={() => eliminarRol(idx)}
                                                                className="text-red-600 hover:text-red-800"
                                                            >
                                                                <i className="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="border-t pt-6">
                                    <h3 className="text-lg font-semibold mb-4">Asignar Miembros del Equipo (Opcional)</h3>
                                    <div className="space-y-4">
                                        <div className="flex space-x-3">
                                            <select
                                                value={miembroSeleccionado}
                                                onChange={(e) => setMiembroSeleccionado(e.target.value)}
                                                className="flex-1 px-4 py-2 border rounded-lg"
                                            >
                                                <option value="">Seleccionar miembro...</option>
                                                {miembros?.map(m => (
                                                    <option key={m.id} value={m.id}>{m.nombre}</option>
                                                ))}
                                            </select>
                                            <div className="flex items-center space-x-2">
                                                <input
                                                    type="number"
                                                    min="1"
                                                    max="100"
                                                    value={porcentajeAsignacion}
                                                    onChange={(e) => setPorcentajeAsignacion(parseInt(e.target.value) || 0)}
                                                    className="w-20 px-3 py-2 border rounded-lg text-center"
                                                />
                                                <span className="text-sm text-gray-600">%</span>
                                            </div>
                                            <button
                                                type="button"
                                                onClick={agregarAsignacion}
                                                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                            >
                                                <i className="fas fa-plus mr-2"></i>Agregar
                                            </button>
                                        </div>

                                        {asignaciones.length > 0 && (
                                            <div className="border rounded-lg p-4">
                                                <p className="text-sm font-medium text-gray-700 mb-3">
                                                    Miembros asignados ({asignaciones.length})
                                                </p>
                                                <div className="space-y-2">
                                                    {asignaciones.map(asig => {
                                                        const miembro = miembros?.find(m => m.id === asig.miembroId);
                                                        return miembro ? (
                                                            <div key={asig.miembroId} className="flex justify-between items-center p-2 bg-gray-50 rounded">
                                                                <div>
                                                                    <span className="font-medium">{miembro.nombre}</span>
                                                                    <span className="ml-2 text-sm text-gray-600">
                                                                        ({asig.porcentaje}% de tiempo)
                                                                    </span>
                                                                </div>
                                                                <button
                                                                    type="button"
                                                                    onClick={() => eliminarAsignacion(asig.miembroId)}
                                                                    className="text-red-600 hover:text-red-800"
                                                                >
                                                                    <i className="fas fa-times"></i>
                                                                </button>
                                                            </div>
                                                        ) : null;
                                                    })}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="flex justify-end space-x-3 pt-4 border-t">
                                    <button type="button" onClick={onCerrar} className="px-6 py-2 border rounded-lg hover:bg-gray-50">
                                        Cancelar
                                    </button>
                                    <button type="submit" className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                                        {proyecto ? 'Guardar' : 'Crear'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
